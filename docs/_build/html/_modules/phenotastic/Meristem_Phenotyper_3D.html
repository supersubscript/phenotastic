
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>phenotastic.Meristem_Phenotyper_3D &#8212; Phenotastic 0.1.0 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for phenotastic.Meristem_Phenotyper_3D</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python2</span>
<span class="c1"># -*- coding: utf-8 -*-</span>

<span class="c1">#######</span>
<span class="c1">#</span>
<span class="c1"># File author(s): Max BRAMBACH &lt;max.brambach.0065@student.lu.se&gt;</span>
<span class="c1">#                 Henrik ÅHL &lt;henrik.aahl@slcu.cam.ac.uk&gt;</span>
<span class="c1"># Copyright (c) 2017, Max Brambach, Henrik Åhl</span>
<span class="c1"># All rights reserved.</span>
<span class="c1"># * Redistribution and use in source and binary forms, with or without</span>
<span class="c1"># * modification, are not permitted.</span>
<span class="c1">#</span>
<span class="c1">############################################################################</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage.morphology</span> <span class="k">import</span> <span class="n">binary_dilation</span><span class="p">,</span> <span class="n">binary_erosion</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage.interpolation</span> <span class="k">import</span> <span class="n">zoom</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">cycle</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">opt</span>
<span class="c1">#from tissueviewer.mesh import tvMeshImageVTK</span>
<span class="kn">import</span> <span class="nn">vtk</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">vtk.util.numpy_support</span> <span class="k">import</span> <span class="n">vtk_to_numpy</span>
<span class="kn">import</span> <span class="nn">vtk.util.numpy_support</span> <span class="k">as</span> <span class="nn">nps</span>

<span class="kn">import</span> <span class="nn">colorsys</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="c1">#from tissueviewer.tvtiff import tiffread, tiffsave</span>
<span class="kn">from</span> <span class="nn">libtiff</span> <span class="k">import</span> <span class="n">TIFF</span>
<span class="kn">import</span> <span class="nn">handy_functions</span> <span class="k">as</span> <span class="nn">hf</span>
<span class="kn">from</span> <span class="nn">vtk.util</span> <span class="k">import</span> <span class="n">numpy_support</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">domain_processing</span> <span class="k">as</span> <span class="nn">boa</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">tifffile</span> <span class="k">as</span> <span class="nn">tiff</span>
<span class="kn">import</span> <span class="nn">vtkInterface</span> <span class="k">as</span> <span class="nn">vi</span>
<span class="kn">from</span> <span class="nn">vtkInterface</span> <span class="k">import</span> <span class="n">PolyData</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">===================</span>
<span class="sd">AutoPhenotype class</span>
<span class="sd">===================</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Definition &amp; Methods</span>
<span class="sd">===================</span>
<span class="sd">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="AutoPhenotype"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.AutoPhenotype">[docs]</a><span class="k">class</span> <span class="nc">AutoPhenotype</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A python class for the automated extraction of SAM features in three</span>
<span class="sd">    dimensions from a stack of confocal microscope images.</span>

<span class="sd">    AutoPhenotype is a python class for the automated extraction of features of</span>
<span class="sd">    a shoot apical meristem (SAM) from a stack of confocal microscope images.</span>
<span class="sd">    Its main features are:</span>

<span class="sd">    *Extraction of the SAMs surface using active contour without edges (ACWE).</span>
<span class="sd">    *Separation of the SAMs features into primordiae and the meristem.</span>
<span class="sd">    *Evaluation of the features in terms of location, size and divergence angle.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    data : 3D intensity array</span>
<span class="sd">        Image data e.g. from .tif file.</span>

<span class="sd">    tags : unused</span>

<span class="sd">    contour : 3D boolean array</span>
<span class="sd">        Contour generated from data.</span>

<span class="sd">    mesh : vtkPolyData</span>
<span class="sd">        Mesh generated from contour. Can contain curvature values.</span>

<span class="sd">    features : list of vtkPolyData</span>
<span class="sd">        The extracted features from mesh.</span>

<span class="sd">    results : panda.DataFrame</span>
<span class="sd">        The results of the evaluation operations (e.g. sphere fit). Also</span>
<span class="sd">        contains the number of points contained in each feature and its</span>
<span class="sd">        curvature.</span>
<span class="sd">        The number of rows is the number of primordia, whereas the  number of</span>
<span class="sd">        columns depends on the number of evaluation operations performed. New</span>
<span class="sd">        results are appended.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">contour</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Builder&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="n">tags</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contour</span> <span class="o">=</span> <span class="n">contour</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">mesh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;points_in_feature&#39;</span><span class="p">])</span>

<div class="viewcode-block" id="AutoPhenotype.contour_fit_threshold"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.AutoPhenotype.contour_fit_threshold">[docs]</a>    <span class="k">def</span> <span class="nf">contour_fit_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=.</span><span class="mi">8</span><span class="p">,</span> <span class="n">smooth_iterate</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate contour fit via a threshold.</span>

<span class="sd">        Uses a threshold based approach to generate the initial model of</span>
<span class="sd">        self.data. Threshold default is half of the images mean intensity;</span>
<span class="sd">        can be adjusted.</span>
<span class="sd">        Subsequently, the contour is smoothed</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        threshold : float</span>
<span class="sd">            Sets the threshold for a voxel to be considered in- or outside the</span>
<span class="sd">            contour.</span>
<span class="sd">                *Inside: intensity(voxel) &gt; mean_intensity/2*threshold</span>
<span class="sd">                *Outside: else</span>

<span class="sd">        iterate_smooth : int</span>
<span class="sd">            Number of times, the smoothing operation is performed.</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        no return :</span>
<span class="sd">            Overwrites contour.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contour</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">&lt;</span>
                                <span class="n">threshold</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">flatten</span><span class="p">()),</span>
                                <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span></div>
        <span class="bp">self</span><span class="o">.</span><span class="n">smooth_contour</span><span class="p">(</span><span class="n">smooth_iterate</span><span class="p">)</span>

<div class="viewcode-block" id="AutoPhenotype.step"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.AutoPhenotype.step">[docs]</a>    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weighting</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform a single step of the morphological Chan-Vese evolution.</span>

<span class="sd">        Implementation of the first two parts of Equation 32 in Marquez-Neila</span>
<span class="sd">        et al. 2014. (DOI: 10.1109/TPAMI.2013.106). The third part (smoothing)</span>
<span class="sd">        is implemented in the smooth_contour method.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        weighting : float</span>
<span class="sd">            Ratio of the weightings of the inside to outside intensity.</span>
<span class="sd">            (lambda_1/lambda_2 in Equation 32, where lambda_2 is chosen to be 1</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        no return :</span>
<span class="sd">            Overwrite self.contour.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contour</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;the levelset function is not set (use .contour=)&quot;</span><span class="p">)</span>
        <span class="n">inside</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contour</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">outside</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contour</span> <span class="o">&lt;=</span> <span class="mi">0</span>
        <span class="n">c0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">outside</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">outside</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">inside</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">inside</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="n">dres</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contour</span><span class="p">))</span>
        <span class="n">abs_dres</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dres</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">aux</span> <span class="o">=</span> <span class="n">abs_dres</span> <span class="o">*</span> <span class="p">(</span><span class="n">weighting</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">-</span> <span class="n">c1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span>
                          <span class="mf">1.</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">weighting</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">-</span> <span class="n">c0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contour</span><span class="p">[</span><span class="n">aux</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span></div>
        <span class="bp">self</span><span class="o">.</span><span class="n">contour</span><span class="p">[</span><span class="n">aux</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<div class="viewcode-block" id="AutoPhenotype.smooth_contour"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.AutoPhenotype.smooth_contour">[docs]</a>    <span class="k">def</span> <span class="nf">smooth_contour</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterate</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Smooth contour with ISoSI, SIoIS operators.</span>

<span class="sd">        Uses the SIoIS and ISoSI operator of Marquez-Neila et al. 2014</span>
<span class="sd">        (Section 3.5) to smooth the contour. At least one iteration after step</span>
<span class="sd">        is needed to get a good contour.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">curvop</span> <span class="o">=</span> <span class="n">fcycle</span><span class="p">([</span><span class="n">SIoIS</span><span class="p">,</span> <span class="n">ISoSI</span><span class="p">])</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contour</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">iterate</span><span class="p">):</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">curvop</span><span class="p">(</span><span class="n">res</span><span class="p">)</span></div>
        <span class="bp">self</span><span class="o">.</span><span class="n">contour</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int16&#39;</span><span class="p">)</span>

    <span class="c1"># TODO:</span>
<div class="viewcode-block" id="AutoPhenotype.quadric_decimation"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.AutoPhenotype.quadric_decimation">[docs]</a>    <span class="k">def</span> <span class="nf">quadric_decimation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;percentage&quot;</span><span class="p">):</span>
      <span class="n">decimate</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkQuadricDecimation</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;percentage&quot;</span><span class="p">:</span>
        <span class="n">decimate</span><span class="o">.</span><span class="n">SetTargetReduction</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span>
      <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;npoints&quot;</span><span class="p">:</span>
        <span class="n">decimate</span><span class="o">.</span><span class="n">SetTargetReduction</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">())</span>

      <span class="n">decimate</span><span class="o">.</span><span class="n">VolumePreservationOn</span><span class="p">()</span>
      <span class="n">decimate</span><span class="o">.</span><span class="n">NormalsAttributeOn</span><span class="p">()</span>

      <span class="k">if</span> <span class="n">vtk</span><span class="o">.</span><span class="n">VTK_MAJOR_VERSION</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
        <span class="n">decimate</span><span class="o">.</span><span class="n">SetInputConnection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">GetProducerPort</span><span class="p">())</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">decimate</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>

      <span class="n">decimate</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
</div>
      <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">PolyData</span><span class="p">(</span><span class="n">decimate</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">())</span>

    <span class="c1"># TODO:</span>
<div class="viewcode-block" id="AutoPhenotype.reduce"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.AutoPhenotype.reduce">[docs]</a>    <span class="k">def</span> <span class="nf">reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">spline</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reduce the size of contour and data by the specified factor using</span>
<span class="sd">        slicing.</span>

<span class="sd">        The method deletes the unused planes (keeps only every nth - n=factor).</span>
<span class="sd">        Can also use spline filters for up and downsampling.</span>

<span class="sd">        Parameter</span>
<span class="sd">        ---------</span>
<span class="sd">        factor : int if spline = False, float else</span>
<span class="sd">            Specify the factor of reduction.</span>

<span class="sd">        spline : boolean</span>
<span class="sd">            *if False (default): use numpy slicing to reduce number of planes.</span>
<span class="sd">            *if True: use spline interpolation for reducing / enlarging data and</span>
<span class="sd">              contour.</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        no return :</span>
<span class="sd">            overwrite self.contour and self.data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">spline</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[::</span><span class="n">factor</span><span class="p">,</span> <span class="p">::</span><span class="n">factor</span><span class="p">,</span> <span class="p">::</span><span class="n">factor</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contour</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">contour</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contour</span><span class="p">[::</span><span class="n">factor</span><span class="p">,</span> <span class="p">::</span><span class="n">factor</span><span class="p">,</span> <span class="p">::</span><span class="n">factor</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">spline</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">zoom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="mf">1.</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">factor</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contour</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span></div>
                <span class="bp">self</span><span class="o">.</span><span class="n">contour</span> <span class="o">=</span> <span class="n">zoom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contour</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="mf">1.</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">factor</span><span class="p">))</span>

    <span class="c1"># TODO:</span>
<div class="viewcode-block" id="AutoPhenotype.invert_normals"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.AutoPhenotype.invert_normals">[docs]</a>    <span class="k">def</span> <span class="nf">invert_normals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="n">reverse</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkReverseSense</span><span class="p">()</span>
      <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">vtk</span><span class="o">.</span><span class="n">vtkVersion</span><span class="p">()</span><span class="o">.</span><span class="n">GetVTKVersion</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
        <span class="n">reverse</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">reverse</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
      <span class="n">reverse</span><span class="o">.</span><span class="n">ReverseCellsOn</span><span class="p">()</span>
      <span class="n">reverse</span><span class="o">.</span><span class="n">ReverseNormalsOn</span><span class="p">()</span></div>
      <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">PolyData</span><span class="p">(</span><span class="n">reverse</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">())</span>

    <span class="c1"># TODO:</span>
<div class="viewcode-block" id="AutoPhenotype.fill_holes"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.AutoPhenotype.fill_holes">[docs]</a>    <span class="k">def</span> <span class="nf">fill_holes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="c1"># Crashes atm. Might very well be current VTK version</span>
        <span class="n">fill</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkFillHolesFilter</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">vtk</span><span class="o">.</span><span class="n">vtkVersion</span><span class="p">()</span><span class="o">.</span><span class="n">GetVTKVersion</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
          <span class="n">fill</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">fill</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>

        <span class="n">fill</span><span class="o">.</span><span class="n">SetHoleSize</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

        <span class="c1"># Make triangle window ordering consistent</span>
        <span class="n">normals</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolyDataNormals</span><span class="p">()</span>
        <span class="n">normals</span><span class="o">.</span><span class="n">SetInputConnection</span><span class="p">(</span><span class="n">fill</span><span class="o">.</span><span class="n">GetOutputPort</span><span class="p">())</span>
        <span class="n">normals</span><span class="o">.</span><span class="n">ConsistencyOn</span><span class="p">()</span>
        <span class="n">normals</span><span class="o">.</span><span class="n">SplittingOff</span><span class="p">()</span>
        <span class="n">normals</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>

        <span class="c1"># Restore the original normals</span>
        <span class="n">normals</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">SetNormals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetNormals</span><span class="p">())</span>
        <span class="n">normals</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
</div>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">PolyData</span><span class="p">(</span><span class="n">normals</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">())</span>

    <span class="c1"># TODO:</span>
<div class="viewcode-block" id="AutoPhenotype.update_mesh"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.AutoPhenotype.update_mesh">[docs]</a>    <span class="k">def</span> <span class="nf">update_mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">vtk</span><span class="o">.</span><span class="n">VTK_MAJOR_VERSION</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
      <span class="k">else</span><span class="p">:</span></div>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">Modified</span><span class="p">()</span>

<div class="viewcode-block" id="AutoPhenotype.contour_fit"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.AutoPhenotype.contour_fit">[docs]</a>    <span class="k">def</span> <span class="nf">contour_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weighting</span><span class="p">,</span> <span class="n">iterate_smooth</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run several full iterations of the morphological Chan-Vese method.</span>

<span class="sd">        Implementation of Equation 32 in Marquez-Neila et al. 2014.</span>
<span class="sd">        (DOI: 10.1109/TPAMI.2013.106).</span>

<span class="sd">        Parameter</span>
<span class="sd">        ---------</span>
<span class="sd">        iterations : int</span>
<span class="sd">            Number of times, the Chan-Vese Method is iterated.</span>

<span class="sd">        weighting : float</span>
<span class="sd">            Ratio of the weightings of the outside and inside contour.</span>

<span class="sd">        iterate_smooth : int</span>
<span class="sd">            Number of times, the smoothing operation is performed during one</span>
<span class="sd">            iteration.</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        no return :</span>
<span class="sd">            overwrite contour.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">iterations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_contour_to_box</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">weighting</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smooth_contour</span><span class="p">(</span><span class="n">iterate_smooth</span><span class="p">)</span></div>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Contour fit: iteration </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">iterations</span><span class="p">))</span>

<div class="viewcode-block" id="AutoPhenotype.contour_fit_two_stage"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.AutoPhenotype.contour_fit_two_stage">[docs]</a>    <span class="k">def</span> <span class="nf">contour_fit_two_stage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterations1</span><span class="p">,</span> <span class="n">weighting1</span><span class="p">,</span> <span class="n">iterate_smooth1</span><span class="p">,</span>
                              <span class="n">iterations2</span><span class="p">,</span> <span class="n">weighting2</span><span class="p">,</span> <span class="n">iterate_smooth2</span><span class="p">,</span>
                              <span class="n">zoom_factor</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run a two staged contour fit. First fit is on down sampled image.</span>

<span class="sd">        The generated contour from the first fit is then up sampled and is used</span>
<span class="sd">        as initial contour for the regular fit.</span>

<span class="sd">        Parameter</span>
<span class="sd">        ---------</span>
<span class="sd">        iterations1,2 : int</span>
<span class="sd">            Number of times, the Chan-Vese Method is iterated.</span>
<span class="sd">            1 -&gt;</span>

<span class="sd">        weighting1,2 : float</span>
<span class="sd">            Ratio of the weightings of the outside and inside contour.</span>

<span class="sd">        iterate_smooth1,2 : int</span>
<span class="sd">            Number of times, the smoothing operation is performed during one</span>
<span class="sd">            iteration.</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        no return :</span>
<span class="sd">            overwrite contour.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data_large</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
        <span class="n">data_small</span> <span class="o">=</span> <span class="n">zoom</span><span class="p">(</span><span class="n">data_large</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">zoom_factor</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data_small</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_contour_to_box</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contour_fit</span><span class="p">(</span><span class="n">iterations1</span><span class="p">,</span> <span class="n">weighting1</span><span class="p">,</span> <span class="n">iterate_smooth1</span><span class="p">)</span>
        <span class="n">data_large_shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">data_large</span><span class="p">)</span>
        <span class="n">contour_large</span> <span class="o">=</span> <span class="n">zoom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contour</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="mf">1.</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">zoom_factor</span><span class="p">)</span> <span class="o">+</span> <span class="o">.</span><span class="mi">05</span><span class="p">)</span>
        <span class="n">contour_large</span> <span class="o">=</span> <span class="n">contour_large</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">data_large_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                      <span class="mi">0</span><span class="p">:</span><span class="n">data_large_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                      <span class="mi">0</span><span class="p">:</span><span class="n">data_large_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data_large</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contour</span> <span class="o">=</span> <span class="n">contour_large</span></div>
        <span class="bp">self</span><span class="o">.</span><span class="n">contour_fit</span><span class="p">(</span><span class="n">iterations2</span><span class="p">,</span> <span class="n">weighting2</span><span class="p">,</span> <span class="n">iterate_smooth2</span><span class="p">)</span>

<div class="viewcode-block" id="AutoPhenotype.set_contour_to_box"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.AutoPhenotype.set_contour_to_box">[docs]</a>    <span class="k">def</span> <span class="nf">set_contour_to_box</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the contour attribute to a box.</span>

<span class="sd">        The box consists of ones on the surfaces except the edges and the first</span>
<span class="sd">        plane on the first axis (axis = 0). The rest is zeros.</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        no return :</span>
<span class="sd">            Overwrites contour.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">contour</span> <span class="o">=</span> <span class="n">getplanes</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
        <span class="n">contour</span> <span class="o">=</span> <span class="n">setedges</span><span class="p">(</span><span class="n">contour</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">contour</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span></div>
        <span class="bp">self</span><span class="o">.</span><span class="n">contour</span> <span class="o">=</span> <span class="n">contour</span>

<div class="viewcode-block" id="AutoPhenotype.mesh_conversion"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.AutoPhenotype.mesh_conversion">[docs]</a>    <span class="k">def</span> <span class="nf">mesh_conversion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert contour to mesh using marching cubes.</span>

<span class="sd">        Uses the marching cubes algorithm from vtk and the tvMeshImageVTK</span>
<span class="sd">        function is from tissuviewer.</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        no return :</span>
<span class="sd">            Overwrites mesh.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fitval</span> <span class="o">=</span> <span class="mi">127</span>  <span class="c1"># used to be 122, I think. Not sure what this sets</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contour</span>
        <span class="n">fit</span><span class="p">[</span><span class="n">fit</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">fitval</span>
<span class="c1">#         blockPrint()</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="n">tvMeshImageVTK</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="n">removeBoundaryCells</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                              <span class="n">smooth_steps</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="c1">#         enablePrint()</span></div>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">mesh</span><span class="p">[</span><span class="n">fitval</span><span class="p">]</span>

<div class="viewcode-block" id="AutoPhenotype.clean_mesh"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.AutoPhenotype.clean_mesh">[docs]</a>    <span class="k">def</span> <span class="nf">clean_mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract largest connected set in self.mesh.</span>

<span class="sd">        Can be used to reduce residues of the contour fit inside the meristem.</span>
<span class="sd">        Works only if residues are not connected (share at least one point with)</span>
<span class="sd">        the meristems surface.</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        no return :</span>
<span class="sd">            Overwrites mesh.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">connect</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkConnectivityFilter</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">vtk</span><span class="o">.</span><span class="n">VTK_MAJOR_VERSION</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
          <span class="n">connect</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">connect</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>

        <span class="n">connect</span><span class="o">.</span><span class="n">SetExtractionModeToLargestRegion</span><span class="p">()</span>
        <span class="n">connect</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
        <span class="n">geofilter</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkGeometryFilter</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">vtk</span><span class="o">.</span><span class="n">VTK_MAJOR_VERSION</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
          <span class="n">geofilter</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="n">connect</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">geofilter</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">connect</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">())</span>

        <span class="n">geofilter</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span></div>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">PolyData</span><span class="p">(</span><span class="n">geofilter</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">())</span>


<div class="viewcode-block" id="AutoPhenotype.smooth_mesh"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.AutoPhenotype.smooth_mesh">[docs]</a>    <span class="k">def</span> <span class="nf">smooth_mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">relaxation_factor</span><span class="o">=.</span><span class="mi">5</span><span class="p">,</span>
                    <span class="n">featureEdgeSmoothing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">boundarySmoothing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">feature_angle</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">edge_angle</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Smooth mesh.</span>

<span class="sd">        Uses vtk methods to clean and smooth the mesh. See documentation of</span>
<span class="sd">        vtkSmoothPolyData and vtkCleanPolyData for more info.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        iterations : int</span>
<span class="sd">            Number of iterations of the smooth algorithm.</span>

<span class="sd">        relaxation_factor: float</span>
<span class="sd">            Relaxation factor of the smooth algorithm.</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        no return :</span>
<span class="sd">            Overwrites mesh.</span>
<span class="sd">        &quot;&quot;&quot;</span>
<span class="c1">#        cleanPolyData = vtk.vtkCleanPolyData()</span>
<span class="c1">#</span>
        <span class="n">smoothFilter</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkSmoothPolyDataFilter</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">vtk</span><span class="o">.</span><span class="n">VTK_MAJOR_VERSION</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
          <span class="n">smoothFilter</span><span class="o">.</span><span class="n">SetInputConnection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">GetOutputPort</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">smoothFilter</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>

        <span class="n">smoothFilter</span><span class="o">.</span><span class="n">SetNumberOfIterations</span><span class="p">(</span><span class="n">iterations</span><span class="p">)</span>
        <span class="n">smoothFilter</span><span class="o">.</span><span class="n">SetRelaxationFactor</span><span class="p">(</span><span class="n">relaxation_factor</span><span class="p">)</span>
        <span class="n">smoothFilter</span><span class="o">.</span><span class="n">SetFeatureAngle</span><span class="p">(</span><span class="n">feature_angle</span><span class="p">)</span>
        <span class="n">smoothFilter</span><span class="o">.</span><span class="n">SetEdgeAngle</span><span class="p">(</span><span class="n">edge_angle</span><span class="p">)</span>
        <span class="n">smoothFilter</span><span class="o">.</span><span class="n">SetOutputPointsPrecision</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Set special smoothing settings</span>
        <span class="k">if</span> <span class="n">featureEdgeSmoothing</span><span class="p">:</span>
            <span class="n">smoothFilter</span><span class="o">.</span><span class="n">FeatureEdgeSmoothingOn</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">smoothFilter</span><span class="o">.</span><span class="n">FeatureEdgeSmoothingOff</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">boundarySmoothing</span><span class="p">:</span>
            <span class="n">smoothFilter</span><span class="o">.</span><span class="n">BoundarySmoothingOn</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">smoothFilter</span><span class="o">.</span><span class="n">BoundarySmoothingOff</span><span class="p">()</span>
        <span class="n">smoothFilter</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
<span class="c1">#</span></div>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">PolyData</span><span class="p">(</span><span class="n">smoothFilter</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">())</span>

<div class="viewcode-block" id="AutoPhenotype.triangulate"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.AutoPhenotype.triangulate">[docs]</a>    <span class="k">def</span> <span class="nf">triangulate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="n">triangleFilter</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkTriangleFilter</span><span class="p">()</span>

      <span class="k">if</span> <span class="n">vtk</span><span class="o">.</span><span class="n">VTK_MAJOR_VERSION</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">triangleFilter</span><span class="o">.</span><span class="n">SetInputConnection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">GetProducerPort</span><span class="p">())</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">triangleFilter</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>

      <span class="n">triangleFilter</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span></div>
      <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">PolyData</span><span class="p">(</span><span class="n">triangleFilter</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">())</span>

<div class="viewcode-block" id="AutoPhenotype.decimate_mesh"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.AutoPhenotype.decimate_mesh">[docs]</a>    <span class="k">def</span> <span class="nf">decimate_mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fraction</span><span class="p">):</span>
        <span class="n">decimate</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkDecimatePro</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">vtk</span><span class="o">.</span><span class="n">VTK_MAJOR_VERSION</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
          <span class="n">decimate</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">decimate</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
        <span class="c1"># //10% reduction (if there was 100 triangles, now there will be 90)</span>
        <span class="n">decimate</span><span class="o">.</span><span class="n">SetTargetReduction</span><span class="p">(</span><span class="n">fraction</span><span class="p">)</span>
        <span class="n">decimate</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
</div>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">PolyData</span><span class="p">(</span><span class="n">decimate</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">())</span>

<div class="viewcode-block" id="AutoPhenotype.compute_normals"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.AutoPhenotype.compute_normals">[docs]</a>    <span class="k">def</span> <span class="nf">compute_normals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">normalGenerator</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolyDataNormals</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">vtk</span><span class="o">.</span><span class="n">VTK_MAJOR_VERSION</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
          <span class="n">normalGenerator</span><span class="o">.</span><span class="n">SetInputConnection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">GetProducerPort</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">normalGenerator</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>

        <span class="n">normalGenerator</span><span class="o">.</span><span class="n">ComputePointNormalsOn</span><span class="p">()</span>
        <span class="n">normalGenerator</span><span class="o">.</span><span class="n">ComputeCellNormalsOn</span><span class="p">()</span>
        <span class="n">normalGenerator</span><span class="o">.</span><span class="n">SplittingOff</span><span class="p">()</span>
        <span class="n">normalGenerator</span><span class="o">.</span><span class="n">FlipNormalsOn</span><span class="p">()</span>
        <span class="n">normalGenerator</span><span class="o">.</span><span class="n">ConsistencyOn</span><span class="p">()</span>
        <span class="n">normalGenerator</span><span class="o">.</span><span class="n">AutoOrientNormalsOn</span><span class="p">()</span>
        <span class="n">normalGenerator</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span></div>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">PolyData</span><span class="p">(</span><span class="n">normalGenerator</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">())</span>

    <span class="c1"># TODO:</span>
<div class="viewcode-block" id="AutoPhenotype.calculate_curvatures"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.AutoPhenotype.calculate_curvatures">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_curvatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">curv_types</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="n">operations</span><span class="o">=</span><span class="p">[]):</span>
      <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">operations</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">curv_types</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
      <span class="c1"># TODO: Do in polish notation?</span>
      <span class="c1"># Calculate the different curvatures</span>
      <span class="n">frames</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">curv_types</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ii</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span>
          <span class="n">frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curvature_mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">ii</span> <span class="o">==</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span>
          <span class="n">frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curvature_max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">ii</span> <span class="o">==</span> <span class="s1">&#39;min&#39;</span><span class="p">:</span>
          <span class="n">frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curvature_min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">ii</span> <span class="o">==</span> <span class="s1">&#39;gauss&#39;</span><span class="p">:</span>
          <span class="n">frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curvature_gauss</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">))</span>

      <span class="c1"># Sum it up</span>
      <span class="n">total</span> <span class="o">=</span> <span class="n">frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">operations</span><span class="p">)):</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="s2">&quot;total&quot;</span> <span class="o">+</span> <span class="n">operations</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;(frames[ii + 1] + 1e-9)&quot;</span><span class="p">)</span>

      <span class="n">curv_type_name</span> <span class="o">=</span> <span class="n">curv_types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">operations</span><span class="p">)):</span>
        <span class="n">curv_type_name</span> <span class="o">+=</span> <span class="n">operations</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">+</span> <span class="n">curv_types</span><span class="p">[</span><span class="mi">1</span><span class="p">:][</span><span class="n">ii</span><span class="p">]</span>

      <span class="n">total</span> <span class="o">=</span> <span class="n">nps</span><span class="o">.</span><span class="n">numpy_to_vtk</span><span class="p">(</span><span class="n">total</span><span class="p">,</span> <span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">array_type</span><span class="o">=</span><span class="n">vtk</span><span class="o">.</span><span class="n">VTK_DOUBLE</span><span class="p">)</span>
      <span class="n">total</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="n">curv_type_name</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">SetActiveScalars</span><span class="p">(</span><span class="n">curv_type_name</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">curvature_type</span> <span class="o">=</span> <span class="n">curv_type_name</span></div>
      <span class="bp">self</span><span class="o">.</span><span class="n">update_mesh</span><span class="p">()</span>

<div class="viewcode-block" id="AutoPhenotype.mesh_from_arrays"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.AutoPhenotype.mesh_from_arrays">[docs]</a>    <span class="k">def</span> <span class="nf">mesh_from_arrays</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verts</span><span class="p">,</span> <span class="n">faces</span><span class="p">):</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPoints</span><span class="p">()</span>
        <span class="n">points</span><span class="o">.</span><span class="n">SetData</span><span class="p">(</span><span class="n">nps</span><span class="o">.</span><span class="n">numpy_to_vtk</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">verts</span><span class="p">),</span> <span class="n">array_type</span><span class="o">=</span><span class="n">vtk</span><span class="o">.</span><span class="n">VTK_FLOAT</span><span class="p">,</span> <span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">nFaces</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">faces</span><span class="p">)</span>
        <span class="n">faces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ii</span><span class="p">),</span> <span class="n">ii</span><span class="p">)</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">faces</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">polygons</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkCellArray</span><span class="p">()</span>
        <span class="n">polygons</span><span class="o">.</span><span class="n">SetCells</span><span class="p">(</span><span class="n">nFaces</span><span class="p">,</span> <span class="n">nps</span><span class="o">.</span><span class="n">numpy_to_vtk</span><span class="p">(</span><span class="n">faces</span><span class="p">,</span> <span class="n">array_type</span><span class="o">=</span><span class="n">vtk</span><span class="o">.</span><span class="n">VTK_ID_TYPE</span><span class="p">))</span>
        <span class="n">polygonPolyData</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolyData</span><span class="p">()</span>
        <span class="n">polygonPolyData</span><span class="o">.</span><span class="n">SetPoints</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
        <span class="n">polygonPolyData</span><span class="o">.</span><span class="n">SetPolys</span><span class="p">(</span><span class="n">polygons</span><span class="p">)</span>
        <span class="n">polygonPolyData</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">PolyData</span><span class="p">(</span><span class="n">polygonPolyData</span><span class="p">)</span>
        <span class="c1"># TODO</span>
        <span class="c1"># for some reason this updates the mesh correctly</span></div>
        <span class="bp">self</span><span class="o">.</span><span class="n">smooth_mesh</span><span class="p">(</span><span class="n">iterations</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">relaxation_factor</span><span class="o">=.</span><span class="mi">0</span><span class="p">)</span>

<div class="viewcode-block" id="AutoPhenotype.curvature_slice"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.AutoPhenotype.curvature_slice">[docs]</a>    <span class="k">def</span> <span class="nf">curvature_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">curv_types</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="n">operations</span><span class="o">=</span><span class="p">[],</span> <span class="n">lower</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Slice the mesh along (negative) curvature.</span>

<span class="sd">        Computes the curvature of the mesh and then uses a threshold filter to</span>
<span class="sd">        remove the parts with negative curvature.</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        no return :</span>
<span class="sd">            Overwrites mesh.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Calculate curvatures</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calculate_curvatures</span><span class="p">(</span><span class="n">curv_types</span><span class="o">=</span><span class="n">curv_types</span><span class="p">,</span> <span class="n">operations</span><span class="o">=</span><span class="n">operations</span><span class="p">)</span>

        <span class="c1"># Should we cut above or below this value?</span>
        <span class="n">borders</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkThreshold</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">lower</span><span class="p">:</span>
            <span class="n">borders</span><span class="o">.</span><span class="n">ThresholdByLower</span><span class="p">(</span><span class="n">threshold</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">borders</span><span class="o">.</span><span class="n">ThresholdByUpper</span><span class="p">(</span><span class="n">threshold</span><span class="p">)</span>

        <span class="c1"># Update mesh</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">vtk</span><span class="o">.</span><span class="n">vtkVersion</span><span class="p">()</span><span class="o">.</span><span class="n">GetVTKVersion</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
          <span class="n">borders</span><span class="o">.</span><span class="n">SetInputConnection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">GetProducerPort</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">borders</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>

        <span class="n">geofilter</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkGeometryFilter</span><span class="p">()</span>
        <span class="n">geofilter</span><span class="o">.</span><span class="n">SetInputConnection</span><span class="p">(</span><span class="n">borders</span><span class="o">.</span><span class="n">GetOutputPort</span><span class="p">())</span>
        <span class="n">geofilter</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span></div>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">PolyData</span><span class="p">(</span><span class="n">geofilter</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">())</span>

<div class="viewcode-block" id="AutoPhenotype.slice_bottom"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.AutoPhenotype.slice_bottom">[docs]</a>    <span class="k">def</span> <span class="nf">slice_bottom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; TODO &#39;&#39;&#39;</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">nps</span><span class="o">.</span><span class="n">vtk_to_numpy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">GetPoints</span><span class="p">()</span><span class="o">.</span><span class="n">GetData</span><span class="p">())[:,</span> <span class="n">dim</span><span class="p">]</span>
        <span class="n">vtkCoords</span> <span class="o">=</span> <span class="n">nps</span><span class="o">.</span><span class="n">numpy_to_vtk</span><span class="p">(</span>
                <span class="n">num_array</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">coords</span><span class="p">),</span> <span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">array_type</span><span class="o">=</span><span class="n">vtk</span><span class="o">.</span><span class="n">VTK_DOUBLE</span><span class="p">)</span>
        <span class="n">vtkCoords</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s1">&#39;Elevation&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">vtkCoords</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">SetActiveScalars</span><span class="p">(</span><span class="s1">&#39;Elevation&#39;</span><span class="p">)</span>

        <span class="c1"># Cut from the bottom up</span>
        <span class="n">borders</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkThreshold</span><span class="p">()</span>
        <span class="n">minimumCoord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
        <span class="n">borders</span><span class="o">.</span><span class="n">ThresholdByUpper</span><span class="p">(</span><span class="n">minimumCoord</span> <span class="o">+</span> <span class="n">threshold</span><span class="p">)</span>

        <span class="c1"># Update mesh</span>
        <span class="n">geoFilter</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkGeometryFilter</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">vtk</span><span class="o">.</span><span class="n">VTK_MAJOR_VERSION</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
          <span class="n">borders</span><span class="o">.</span><span class="n">SetInputConnection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">GetProducerPort</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">borders</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
        <span class="n">geoFilter</span><span class="o">.</span><span class="n">SetInputConnection</span><span class="p">(</span><span class="n">borders</span><span class="o">.</span><span class="n">GetOutputPort</span><span class="p">())</span>
        <span class="n">geoFilter</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span></div>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">PolyData</span><span class="p">(</span><span class="n">geoFilter</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">())</span>


<div class="viewcode-block" id="AutoPhenotype.feature_extraction"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.AutoPhenotype.feature_extraction">[docs]</a>    <span class="k">def</span> <span class="nf">feature_extraction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_percent</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract the SAM features from the sliced mesh.</span>

<span class="sd">        Uses a vtk connectivity filter for the feature extraction.</span>
<span class="sd">        The points of the mesh are numbered. The method steps through the points</span>
<span class="sd">        (stepsize = total#ofPoints/res) and selects the connected surface in</span>
<span class="sd">        which the point lies. The selected surface is saved if:</span>
<span class="sd">            *Its #ofPoints is larger than stepsize</span>
<span class="sd">            *It has not already been selected</span>
<span class="sd">                (#ofPoints != #ofPoints(previous_iterations) )</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        min_percent : float (element of [0,100])</span>
<span class="sd">            Minimum percentage of cells / points in a primordium / SAM to be</span>
<span class="sd">            extracted. Connected regions with less cells / points are ignored.</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        no return :</span>
<span class="sd">            Overwrites features.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">connect</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolyDataConnectivityFilter</span><span class="p">()</span>
        <span class="n">connect</span><span class="o">.</span><span class="n">SetExtractionModeToSpecifiedRegions</span><span class="p">()</span>
        <span class="n">connect</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
        <span class="n">connect</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
        <span class="n">num_regions</span> <span class="o">=</span> <span class="n">connect</span><span class="o">.</span><span class="n">GetNumberOfExtractedRegions</span><span class="p">()</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">connect</span><span class="o">.</span><span class="n">GetInput</span><span class="p">()</span><span class="o">.</span><span class="n">GetNumberOfCells</span><span class="p">()</span>
        <span class="n">connect</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
        <span class="n">objects_vtk</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lastobj</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">curvature</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">thresh</span> <span class="o">=</span> <span class="n">min_percent</span> <span class="o">/</span> <span class="mf">100.</span> <span class="o">*</span> <span class="n">points</span>
        <span class="n">connect</span><span class="o">.</span><span class="n">InitializeSpecifiedRegionList</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_regions</span><span class="p">):</span>
            <span class="n">connect</span><span class="o">.</span><span class="n">AddSpecifiedRegion</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">connect</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">connect</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span>
            <span class="n">temp</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">temp</span><span class="o">.</span><span class="n">GetNumberOfCells</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">thresh</span><span class="p">:</span>
                <span class="n">connect2</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkConnectivityFilter</span><span class="p">()</span>
                <span class="n">connect2</span><span class="o">.</span><span class="n">SetExtractionModeToLargestRegion</span><span class="p">()</span>
                <span class="n">connect2</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
                <span class="n">connect2</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
                <span class="n">geo</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkGeometryFilter</span><span class="p">()</span>
                <span class="n">geo</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="n">connect2</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">())</span>
                <span class="n">geo</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
                <span class="n">objects_vtk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolyData</span><span class="p">())</span>
                <span class="n">objects_vtk</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">DeepCopy</span><span class="p">(</span><span class="n">geo</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">())</span>
                <span class="n">lastobj</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">objects_vtk</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">())</span>
                <span class="n">curv_temp</span> <span class="o">=</span> <span class="n">vtk_to_numpy</span><span class="p">(</span><span class="n">objects_vtk</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">(</span>
                <span class="p">)</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curvature_type</span><span class="p">))</span>
                <span class="n">curvature</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">curv_temp</span><span class="p">)),</span>
                                  <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">curv_temp</span><span class="p">)),</span>
                                  <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">curv_temp</span><span class="p">)),</span>
                                  <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">curv_temp</span><span class="p">))])</span>
            <span class="n">connect</span><span class="o">.</span><span class="n">DeleteSpecifiedRegion</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">objects_vtk</span>
        <span class="n">npoints</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">lastobj</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;points_in_feature&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">npoints</span><span class="p">)</span>
        <span class="n">curv</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">curvature</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mean_curvature&#39;</span><span class="p">,</span>
                                                          <span class="s1">&#39;std_curvature&#39;</span><span class="p">,</span>
                                                          <span class="s1">&#39;max_curvature&#39;</span><span class="p">,</span>
                                                          <span class="s1">&#39;min_curvature&#39;</span><span class="p">])</span></div>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">,</span> <span class="n">curv</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<div class="viewcode-block" id="AutoPhenotype.sphere_fit"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.AutoPhenotype.sphere_fit">[docs]</a>    <span class="k">def</span> <span class="nf">sphere_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fit spheres onto the features.</span>

<span class="sd">        Iterates over the vtkPolyData objects in features and performs a least</span>
<span class="sd">        square fit of a sphere to each feature.</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        self.results : pandas.DataFrame</span>
<span class="sd">            Four additional rows in self.results:</span>
<span class="sd">                *sphere_x_abs: absolute x-coordinate of the center of the</span>
<span class="sd">                    fitted sphere</span>
<span class="sd">                *sphere_y_abs: absolute y-coordinate of the center of the</span>
<span class="sd">                    fitted sphere</span>
<span class="sd">                *sphere_z_abs: absolute z-coordinate of the center of the</span>
<span class="sd">                    fitted sphere</span>
<span class="sd">            Note: absolute means in units of the coordinate system used in</span>
<span class="sd">            self.features.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fit_sphere</span><span class="p">(</span><span class="n">array_from_vtk_polydata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span>
        <span class="n">fitval</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">out</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sphere_x_abs&#39;</span><span class="p">,</span>
                                                      <span class="s1">&#39;sphere_y_abs&#39;</span><span class="p">,</span>
                                                      <span class="s1">&#39;sphere_z_abs&#39;</span><span class="p">,</span>
                                                      <span class="s1">&#39;sphere_radius&#39;</span><span class="p">,</span>
                                                      <span class="s1">&#39;sphere_res_var&#39;</span><span class="p">])</span></div>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">,</span> <span class="n">fitval</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<div class="viewcode-block" id="AutoPhenotype.sort_results"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.AutoPhenotype.sort_results">[docs]</a>    <span class="k">def</span> <span class="nf">sort_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">reset_index</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sort results by specified column.</span>

<span class="sd">        The sorting direction can be adjusted.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        column : str</span>
<span class="sd">            Name of the column by which the array should be sorted.</span>
<span class="sd">            If column = &#39;index&#39;, the array will be sorted by its index</span>

<span class="sd">        ascending : bool</span>
<span class="sd">            Specifies the sorting direction:</span>
<span class="sd">                *False: high-&gt;low</span>
<span class="sd">                *True: low-&gt;high</span>

<span class="sd">        reset_index : bool</span>
<span class="sd">            Reset the row index after sorting the array. If True, the order of</span>
<span class="sd">            self.features is also changed accordingly.</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        no return :</span>
<span class="sd">            Overwrites results</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">column</span> <span class="o">==</span> <span class="s1">&#39;index&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="n">ascending</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reset_index</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>
                                 <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()])</span></div>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="AutoPhenotype.sphere_evaluation"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.AutoPhenotype.sphere_evaluation">[docs]</a>    <span class="k">def</span> <span class="nf">sphere_evaluation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add several results to self.results.</span>

<span class="sd">        Added results are:</span>
<span class="sd">            *&#39;sphere_x_rel&#39;: x-location of the primordium relative to the</span>
<span class="sd">                meristem.</span>
<span class="sd">            *&#39;sphere_y_rel&#39;: y-location of the primordium relative to the</span>
<span class="sd">                meristem.</span>
<span class="sd">            *&#39;sphere_z_rel&#39;: z-location of the primordium relative to the</span>
<span class="sd">                meristem.</span>
<span class="sd">            *&#39;sphere_volume&#39;: Volume of the sphere</span>
<span class="sd">            *&#39;sphere_R&#39;: Distance of the primordium to the meristem.</span>
<span class="sd">            *&#39;sphere_angle_raw&#39;: Angle between the primordia in the y,z plane.</span>
<span class="sd">                Zero is chosen to be z = 0 and y &gt; 0.</span>
<span class="sd">            *--results missing--</span>
<span class="sd">        Note: List of results is newly sorted in a way that the row with index</span>
<span class="sd">        0 is the meristem. The row label is changed accordingly.</span>
<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        no return :</span>
<span class="sd">            Results are updated (see description).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;sphere_radius&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Perform sphere fit first. Use self.sphere_fit()&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sort_results</span><span class="p">(</span><span class="s1">&#39;sphere_radius&#39;</span><span class="p">,</span> <span class="n">reset_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">num_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_obj</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">out</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sphere_volume</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;sphere_radius&#39;</span><span class="p">])</span>  <span class="c1"># volumes</span>
        <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;sphere_x_abs&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span>
            <span class="s1">&#39;sphere_x_abs&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># x relative to meristem</span>
        <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;sphere_y_abs&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span>
            <span class="s1">&#39;sphere_y_abs&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># y relative to meristem</span>
        <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;sphere_z_abs&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span>
            <span class="s1">&#39;sphere_z_abs&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># z relative to meristem</span>
        <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">2</span><span class="p">]</span>
                             <span class="o">**</span> <span class="mf">2.</span> <span class="o">+</span> <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">3</span><span class="p">]</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>  <span class="c1"># R</span>
        <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">3</span><span class="p">])</span>  <span class="c1"># theta&#39;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_obj</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mf">360.</span>
        <span class="n">out_pd</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">out</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sphere_volume&#39;</span><span class="p">,</span>
                                                      <span class="s1">&#39;sphere_x_rel&#39;</span><span class="p">,</span>
                                                      <span class="s1">&#39;sphere_y_rel&#39;</span><span class="p">,</span>
                                                      <span class="s1">&#39;sphere_z_resl&#39;</span><span class="p">,</span>
                                                      <span class="s1">&#39;sphere_R&#39;</span><span class="p">,</span>
                                                      <span class="s1">&#39;sphere_angle_raw&#39;</span><span class="p">])</span></div>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">,</span> <span class="n">out_pd</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<div class="viewcode-block" id="AutoPhenotype.paraboloid_fit_mersitem"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.AutoPhenotype.paraboloid_fit_mersitem">[docs]</a>    <span class="k">def</span> <span class="nf">paraboloid_fit_mersitem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weighted</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fit the mersitem with a paraboloid.</span>

<span class="sd">        Uses the first entry of self.features as meristem.</span>
<span class="sd">        See fit_paraboloid() function for more info.</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        no return :</span>
<span class="sd">            New results are added to self.results</span>
<span class="sd">            *para_p1 ... para_p5: Parameters of the paraboloid fit.</span>
<span class="sd">            *para_alpha,beta,gamma: Rotation of the paraboloid relative to</span>
<span class="sd">              image.</span>
<span class="sd">            *para_apex_x,y,z: Location of the paraboloids apex in coordinates</span>
<span class="sd">              of the image.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">11</span><span class="p">])</span>

        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span>
            <span class="n">array_from_vtk_polydata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span><span class="o">.</span><span class="n">T</span>

        <span class="k">if</span> <span class="n">weighted</span><span class="p">:</span>
            <span class="n">popt</span> <span class="o">=</span> <span class="n">fit_paraboloid_weighted</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">popt</span> <span class="o">=</span> <span class="n">fit_paraboloid</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="p">)</span>

        <span class="n">apex</span> <span class="o">=</span> <span class="n">get_paraboloid_apex</span><span class="p">(</span><span class="n">popt</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">popt</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">apex</span><span class="p">))</span>
        <span class="n">fitval</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">out</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;para_p1&#39;</span><span class="p">,</span>
                                                      <span class="s1">&#39;para_p2&#39;</span><span class="p">,</span>
                                                      <span class="s1">&#39;para_p3&#39;</span><span class="p">,</span>
                                                      <span class="s1">&#39;para_p4&#39;</span><span class="p">,</span>
                                                      <span class="s1">&#39;para_p5&#39;</span><span class="p">,</span>
                                                      <span class="s1">&#39;para_alpha&#39;</span><span class="p">,</span>
                                                      <span class="s1">&#39;para_beta&#39;</span><span class="p">,</span>
                                                      <span class="s1">&#39;para_gamma&#39;</span><span class="p">,</span>
                                                      <span class="s1">&#39;para_apex_x&#39;</span><span class="p">,</span>
                                                      <span class="s1">&#39;para_apex_y&#39;</span><span class="p">,</span>
                                                      <span class="s1">&#39;para_apex_z&#39;</span><span class="p">])</span></div>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">,</span> <span class="n">fitval</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<div class="viewcode-block" id="AutoPhenotype.read_data"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.AutoPhenotype.read_data">[docs]</a>    <span class="k">def</span> <span class="nf">read_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">where</span><span class="p">):</span></div>
      <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">tiffread</span><span class="p">(</span><span class="n">where</span><span class="p">)</span>

<div class="viewcode-block" id="AutoPhenotype.save"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.AutoPhenotype.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">where</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Saves the all data stored in an AutoPhenotype Object.</span>

<span class="sd">        Recognises whether or not data is available and saves only available.</span>
<span class="sd">        Note: it is advised to create a new folder for every save, since</span>
<span class="sd">        multiple files are created which always have the same name.</span>
<span class="sd">        The following files are saved (if avaliable):</span>
<span class="sd">            *data.tif : processed input data (e.g. reduced) as .tif stack</span>
<span class="sd">            *contour.tif : contour of data as .tif stack</span>
<span class="sd">            *mesh.vtp : mesh as vtk .vtp data (readable with</span>
<span class="sd">                vtk.vtkXMLPolyDataReader() )</span>
<span class="sd">            *featuresX.vtp : features in same format as mesh.vtp. Each feature</span>
<span class="sd">                is a separate file and X is a running number starting from 0.</span>
<span class="sd">            *results.csv : the results from e.g. the spherical fit as .csv</span>
<span class="sd">                data generated with pandas DataFrame.to_csv().</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        where : string, path</span>
<span class="sd">            Path to the folder in which the data should be saved. If folder</span>
<span class="sd">            does not exist, it is created.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logfile</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">)),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                                                          <span class="s1">&#39;contour&#39;</span><span class="p">,</span>
                                                          <span class="s1">&#39;mesh&#39;</span><span class="p">,</span>
                                                          <span class="s1">&#39;features&#39;</span><span class="p">,</span>
                                                          <span class="s1">&#39;results&#39;</span><span class="p">,</span>
                                                          <span class="s1">&#39;tags&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">where</span><span class="p">):</span>  <span class="c1"># checks if specified directory exists</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">where</span><span class="p">)</span>         <span class="c1"># creates one if not</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
            <span class="n">logfile</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="c1"># TODO: Save metadata too</span>
            <span class="n">tiff</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">),</span> <span class="n">where</span> <span class="o">+</span> <span class="s1">&#39;/data.tif&#39;</span><span class="p">)</span>
<span class="c1">#            tiffsave(np.array(self.data, &#39;int16&#39;), where + &#39;/data.tif&#39;)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contour</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
            <span class="n">logfile</span><span class="p">[</span><span class="s1">&#39;contour&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="c1"># TODO: Save metadata too</span>
            <span class="n">tiff</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contour</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">),</span> <span class="n">where</span> <span class="o">+</span> <span class="s1">&#39;/contour.tif&#39;</span><span class="p">)</span>
<span class="c1">#            tiffsave(np.array(self.contour, &#39;int16&#39;), where + &#39;/contour.tif&#39;)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
            <span class="n">logfile</span><span class="p">[</span><span class="s1">&#39;mesh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">meshwriter</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataWriter</span><span class="p">()</span>
            <span class="n">meshwriter</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
            <span class="n">meshwriter</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">where</span> <span class="o">+</span> <span class="s1">&#39;/mesh.vtp&#39;</span><span class="p">)</span>
            <span class="n">meshwriter</span><span class="o">.</span><span class="n">Write</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">where</span> <span class="o">+</span> <span class="s1">&#39;/features&#39;</span><span class="p">)</span>
            <span class="n">logfile</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">featurewriter</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataWriter</span><span class="p">()</span>
                <span class="n">featurewriter</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">featurewriter</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">where</span> <span class="o">+</span> <span class="s1">&#39;/features/feature</span><span class="si">%s</span><span class="s1">.vtp&#39;</span>
                                          <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="n">featurewriter</span><span class="o">.</span><span class="n">Write</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logfile</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">where</span> <span class="o">+</span> <span class="s1">&#39;/results.csv&#39;</span><span class="p">)</span></div>
        <span class="n">logfile</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">where</span> <span class="o">+</span> <span class="s1">&#39;/logfile.csv&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="AutoPhenotype.save_results"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.AutoPhenotype.save_results">[docs]</a>    <span class="k">def</span> <span class="nf">save_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">where</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save results to specified directory.</span>

<span class="sd">        Results are saved as .csv file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        where : string</span>
<span class="sd">            Path of the saved file. has to include the new filename wothout</span>
<span class="sd">            extension. .csv is automaticly added.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">where</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="AutoPhenotype.load"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.AutoPhenotype.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load data to existing AutoPhenotype Object.</span>

<span class="sd">        What is loaded can be specified.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        where : string, path</span>
<span class="sd">            Path to the folder from which the data should be loaded from.</span>

<span class="sd">        what : either None, logfile or list of strings</span>
<span class="sd">            *None: Logfile from specified folder is used.</span>
<span class="sd">            *logfile: No logfile is imported, instead the specified logfile is</span>
<span class="sd">                used. E.g. generated by create_logfile() function</span>
<span class="sd">            *list of strings: List of keywords specifying which data should be</span>
<span class="sd">                loaded. See logfile_from_str() for more information.</span>
<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        no return :</span>
<span class="sd">            Attributes are overwritten.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">what</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
            <span class="n">logfile</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">where</span> <span class="o">+</span> <span class="s1">&#39;/logfile.csv&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">what</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="n">create_logfile</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])):</span>
            <span class="n">logfile</span> <span class="o">=</span> <span class="n">what</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">what</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">([</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">]):</span>
            <span class="n">logfile</span> <span class="o">=</span> <span class="n">logfile_from_str</span><span class="p">(</span><span class="n">what</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39; - parameter what is unknown - &#39;</span>
            <span class="nb">print</span> <span class="s1">&#39;If logfile.csv exists in directory (where) use what=None&#39;</span>
            <span class="nb">print</span> <span class="s1">&#39;Else: either create logfile with create_logfile() function&#39;</span>
            <span class="nb">print</span> <span class="s1">&#39;or specify files to load with strings:&#39;</span>
            <span class="nb">print</span> <span class="s1">&#39;all, data, contour, mesh, features, results, tags&#39;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;parameter what is unknown&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">logfile</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">tiffread</span><span class="p">(</span><span class="n">where</span> <span class="o">+</span> <span class="s1">&#39;/data.tif&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">logfile</span><span class="p">[</span><span class="s1">&#39;contour&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">contour</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">tiffread</span><span class="p">(</span><span class="n">where</span> <span class="o">+</span> <span class="s1">&#39;/contour.tif&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">logfile</span><span class="p">[</span><span class="s1">&#39;mesh&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">meshreader</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataReader</span><span class="p">()</span>
            <span class="n">meshreader</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">where</span> <span class="o">+</span> <span class="s1">&#39;/mesh.vtp&#39;</span><span class="p">)</span>
            <span class="n">meshreader</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">PolyData</span><span class="p">(</span><span class="n">meshreader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">logfile</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">number_of_features</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">where</span> <span class="o">+</span> <span class="s1">&#39;/features&#39;</span><span class="p">))[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_features</span><span class="p">):</span>
                <span class="n">featurereader</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataReader</span><span class="p">()</span>
                <span class="n">featurereader</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">where</span> <span class="o">+</span> <span class="s1">&#39;/features/feature</span><span class="si">%s</span><span class="s1">.vtp&#39;</span>
                                          <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="n">featurereader</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolyData</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">DeepCopy</span><span class="p">(</span><span class="n">PolyData</span><span class="p">(</span><span class="n">featurereader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()))</span>
        <span class="k">if</span> <span class="n">logfile</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span></div>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">where</span> <span class="o">+</span> <span class="s1">&#39;/results.csv&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="AutoPhenotype.reset_results"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.AutoPhenotype.reset_results">[docs]</a>    <span class="k">def</span> <span class="nf">reset_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;points_in_feature&#39;</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Reset the result attribute.</span>

<span class="sd">        Results to be kept can be specified. Keeps points_in_feature by default.</span>
<span class="sd">        If all results should be deleted use keep = []</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        keep : list of strings</span>
<span class="sd">            List specifying the results to be kept.</span>
<span class="sd">            E.g. [&#39;points_in_feature&#39;, &#39;sphere_radius&#39;]</span>
<span class="sd">            Note: Has to be list even if it only has one entry.</span>
<span class="sd">            Use [] for no results to be kept.</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        no return :</span>
<span class="sd">            Overwrites self.results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">keep</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">):</span>
            <span class="n">keep</span> <span class="o">=</span> <span class="p">[</span><span class="n">keep</span><span class="p">]</span></div>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span>

<div class="viewcode-block" id="AutoPhenotype.clear"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.AutoPhenotype.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">what</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clear specified attributes.</span>

<span class="sd">        Attributes to be specified can be:</span>
<span class="sd">            *&#39;all&#39;</span>
<span class="sd">            *&#39;data&#39;</span>
<span class="sd">            *&#39;tags&#39;</span>
<span class="sd">            *&#39;contour&#39;</span>
<span class="sd">            *&#39;mesh&#39;</span>
<span class="sd">            *&#39;features&#39;</span>
<span class="sd">            *&#39;results&#39;</span>
<span class="sd">        Specified attributes are reset into initial condition.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        what : list of strings</span>
<span class="sd">            List of attributes to be cleared. See description.</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        no return :</span>
<span class="sd">            Clears attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">what</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">):</span>
            <span class="n">what</span> <span class="o">=</span> <span class="p">[</span><span class="n">what</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">what</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">contour</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;points_in_feature&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="s1">&#39;data&#39;</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">what</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="s1">&#39;tags&#39;</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">what</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="s1">&#39;contour&#39;</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">what</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">contour</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="s1">&#39;mesh&#39;</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">what</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="s1">&#39;features&#39;</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">what</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="s1">&#39;results&#39;</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">what</span><span class="p">):</span></div>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;points_in_feature&#39;</span><span class="p">])</span>

<div class="viewcode-block" id="AutoPhenotype.get_div_angle"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.AutoPhenotype.get_div_angle">[docs]</a>    <span class="k">def</span> <span class="nf">get_div_angle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sort_by</span><span class="o">=</span><span class="s1">&#39;sphere_radius&#39;</span><span class="p">,</span> <span class="n">sort_results</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return divergence angles for angles sorted by sort_by.</span>

<span class="sd">        Can only be used after self.sphere_evaluation() has been used.</span>
<span class="sd">        Note: all angles must be in degree. Output is also in degree.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sort_by : str, index in self.results</span>
<span class="sd">            specify the order in which the organs are.</span>
<span class="sd">            E.g. sort by &#39;sphere_radius&#39;</span>
<span class="sd">            Default is &#39;sphere_radius&#39;.</span>

<span class="sd">        sort_results : bool</span>
<span class="sd">            Specify, if self.results should be sorted accordingly.</span>
<span class="sd">            Default is no sorting.</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        clockwise : float list</span>
<span class="sd">            Difference between angles of the primordiae,</span>
<span class="sd">            clockwise orientation.</span>

<span class="sd">        counterclockwise : float list</span>
<span class="sd">            Difference between angles of the primordiae,</span>
<span class="sd">            counterclockwise orientation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[[</span><span class="s1">&#39;sphere_angle_raw&#39;</span><span class="p">,</span> <span class="n">sort_by</span><span class="p">]]</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">sort_by</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sort_results</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sort_results</span><span class="p">(</span><span class="n">sort_by</span><span class="p">)</span></div>
        <span class="k">return</span> <span class="n">angle_difference</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;sphere_angle_raw&#39;</span><span class="p">])</span>

<div class="viewcode-block" id="AutoPhenotype.show_spheres"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.AutoPhenotype.show_spheres">[docs]</a>    <span class="k">def</span> <span class="nf">show_spheres</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meristem_first</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_actors</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;&quot;3D visualisation of the sphere fit.</span>

<span class="sd">        Uses vtk to show the fitted spheres.</span>
<span class="sd">        Color coding:</span>
<span class="sd">            *White: first entry in self.results</span>
<span class="sd">            *R-&gt;G-&gt;B-&gt;P: following results</span>
<span class="sd">        Note: This makes the script pause at the position of the call. Closing</span>
<span class="sd">        the render window lets the script continue.</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        no return :</span>
<span class="sd">            Opens a render window.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">meristem_first</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">firstcolor</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
            <span class="n">lastcolor</span> <span class="o">=</span> <span class="p">()</span>
        <span class="k">if</span> <span class="n">meristem_first</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">lastcolor</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
            <span class="n">firstcolor</span> <span class="o">=</span> <span class="p">()</span>
        <span class="n">spheres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[[</span><span class="s1">&#39;sphere_x_abs&#39;</span><span class="p">,</span> <span class="s1">&#39;sphere_y_abs&#39;</span><span class="p">,</span> <span class="s1">&#39;sphere_z_abs&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;sphere_radius&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()</span>
        <span class="n">sphereResolution</span> <span class="o">=</span> <span class="mi">50</span>
        <span class="n">spheresSources</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">spheres</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">spherevtk</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkSphereSource</span><span class="p">()</span>
            <span class="n">spherevtk</span><span class="o">.</span><span class="n">SetCenter</span><span class="p">(</span><span class="n">spheres</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">spheres</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">spheres</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
            <span class="n">spherevtk</span><span class="o">.</span><span class="n">SetRadius</span><span class="p">(</span><span class="n">spheres</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
            <span class="n">spherevtk</span><span class="o">.</span><span class="n">SetThetaResolution</span><span class="p">(</span><span class="n">sphereResolution</span><span class="p">)</span>
            <span class="n">spherevtk</span><span class="o">.</span><span class="n">SetPhiResolution</span><span class="p">(</span><span class="n">sphereResolution</span><span class="p">)</span>
            <span class="n">spherevtk</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
            <span class="n">spheresSources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PolyData</span><span class="p">(</span><span class="n">spherevtk</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()))</span>
        <span class="k">if</span> <span class="n">return_actors</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">view_polydata</span><span class="p">(</span><span class="n">spheresSources</span><span class="p">,</span> <span class="n">firstcolor</span><span class="p">,</span> <span class="n">lastcolor</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">return_actors</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">view_polydata</span><span class="p">(</span><span class="n">spheresSources</span><span class="p">,</span> <span class="n">firstcolor</span><span class="p">,</span> <span class="n">lastcolor</span><span class="p">,</span></div>
                                 <span class="n">return_actors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># TODO:</span>
<div class="viewcode-block" id="AutoPhenotype.show_paraboloid_and_mesh"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.AutoPhenotype.show_paraboloid_and_mesh">[docs]</a>    <span class="k">def</span> <span class="nf">show_paraboloid_and_mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">sampleDim</span><span class="o">=</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span>
                             <span class="n">bounds</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">):</span>
        <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">p3</span><span class="p">,</span> <span class="n">p4</span><span class="p">,</span> <span class="n">p5</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">=</span> <span class="n">p</span>

        <span class="c1"># Configure</span>
        <span class="n">quadric</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkQuadric</span><span class="p">()</span>
        <span class="n">quadric</span><span class="o">.</span><span class="n">SetCoefficients</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">p3</span><span class="p">,</span> <span class="n">p4</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">p5</span><span class="p">)</span>

        <span class="n">sample</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkSampleFunction</span><span class="p">()</span>
        <span class="n">sample</span><span class="o">.</span><span class="n">SetSampleDimensions</span><span class="p">(</span><span class="n">sampleDim</span><span class="p">)</span>
        <span class="n">sample</span><span class="o">.</span><span class="n">SetImplicitFunction</span><span class="p">(</span><span class="n">quadric</span><span class="p">)</span>
        <span class="n">sample</span><span class="o">.</span><span class="n">SetModelBounds</span><span class="p">(</span><span class="n">bounds</span><span class="p">)</span>
        <span class="n">sample</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>

        <span class="n">contour</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkContourFilter</span><span class="p">()</span>
        <span class="n">contour</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">())</span>
        <span class="n">contour</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>

        <span class="n">contourMapper</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolyDataMapper</span><span class="p">()</span>
        <span class="n">contourMapper</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">contour</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">())</span>
        <span class="n">contourActor</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkActor</span><span class="p">()</span>
        <span class="n">contourActor</span><span class="o">.</span><span class="n">SetMapper</span><span class="p">(</span><span class="n">contourMapper</span><span class="p">)</span>

        <span class="n">rotMat</span> <span class="o">=</span> <span class="n">rot_matrix_44</span><span class="p">([</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">],</span> <span class="n">invert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">trans</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkMatrix4x4</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">rotMat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">rotMat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">trans</span><span class="o">.</span><span class="n">SetElement</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">,</span> <span class="n">rotMat</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="n">jj</span><span class="p">])</span>

        <span class="n">transMat</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkMatrixToHomogeneousTransform</span><span class="p">()</span>
        <span class="n">transMat</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="n">trans</span><span class="p">)</span>
        <span class="n">transformFilter</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkTransformPolyDataFilter</span><span class="p">()</span>
        <span class="n">transformFilter</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">contour</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">())</span>
        <span class="n">transformFilter</span><span class="o">.</span><span class="n">SetTransform</span><span class="p">(</span><span class="n">transMat</span><span class="p">)</span>
        <span class="n">transformFilter</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
        <span class="n">tpoly</span> <span class="o">=</span> <span class="n">vi</span><span class="o">.</span><span class="n">PolyData</span><span class="p">(</span><span class="n">transformFilter</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">())</span>
        <span class="n">tpoly</span><span class="o">.</span><span class="n">ClipPlane</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">GetBounds</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">pobj</span> <span class="o">=</span> <span class="n">vi</span><span class="o">.</span><span class="n">PlotClass</span><span class="p">()</span>
        <span class="n">pobj</span><span class="o">.</span><span class="n">AddMesh</span><span class="p">(</span><span class="n">tpoly</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=.</span><span class="mi">5</span><span class="p">,</span> <span class="n">showedges</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>
        <span class="n">pobj</span><span class="o">.</span><span class="n">AddMesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opcaity</span><span class="o">=.</span><span class="mi">9</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span></div>
        <span class="n">pobj</span><span class="o">.</span><span class="n">Plot</span><span class="p">()</span>

<div class="viewcode-block" id="AutoPhenotype.show_point_values"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.AutoPhenotype.show_point_values">[docs]</a>    <span class="k">def</span> <span class="nf">show_point_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vals</span><span class="p">,</span> <span class="n">stdevs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">discrete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">return_actors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">boaCoords</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">bg</span> <span class="o">=</span> <span class="p">[</span><span class="o">.</span><span class="mi">1</span><span class="p">,</span><span class="o">.</span><span class="mi">2</span><span class="p">,</span><span class="o">.</span><span class="mi">3</span><span class="p">],</span>
                          <span class="n">logScale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ruler</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># TODO: This function is a clusterfuck of a mess</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">))</span>
<span class="c1">#        vals = pd.DataFrame(np.array(pointData[&#39;domain&#39;]))</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolyData</span><span class="p">()</span>
        <span class="n">output</span><span class="o">.</span><span class="n">ShallowCopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">discrete</span><span class="p">:</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">codes</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stdevs</span> <span class="o">!=</span> <span class="s2">&quot;all&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">discrete</span><span class="p">:</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">hf</span><span class="o">.</span><span class="n">reject_outliers_2</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="n">stdevs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">discrete</span><span class="p">:</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">codes</span><span class="p">)</span>
            <span class="n">scalarRange</span> <span class="o">=</span> <span class="p">[</span><span class="n">vals</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vals</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">scalarRange</span> <span class="o">=</span> <span class="p">[</span><span class="n">vals</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vals</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

        <span class="k">if</span> <span class="n">discrete</span><span class="p">:</span>
          <span class="n">cols</span> <span class="o">=</span> <span class="n">hf</span><span class="o">.</span><span class="n">get_max_contrast_colours</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">vals</span><span class="p">)))</span>
          <span class="n">dctf</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkDiscretizableColorTransferFunction</span><span class="p">()</span>
          <span class="n">dctf</span><span class="o">.</span><span class="n">DiscretizeOn</span><span class="p">()</span>
          <span class="n">dctf</span><span class="o">.</span><span class="n">SetRange</span><span class="p">(</span><span class="n">scalarRange</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">scalarRange</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
          <span class="n">dctf</span><span class="o">.</span><span class="n">SetNumberOfValues</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">vals</span><span class="p">)))</span>
          <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)):</span>
            <span class="n">dctf</span><span class="o">.</span><span class="n">AddRGBPoint</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">cols</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">cols</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">cols</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
  <span class="c1">#        dctf.SetNumberOfIndexedColors(len(np.unique(vals)))</span>
          <span class="n">dctf</span><span class="o">.</span><span class="n">Build</span><span class="p">()</span>

          <span class="n">lut</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkLookupTable</span><span class="p">()</span>
          <span class="n">lut</span><span class="o">.</span><span class="n">SetNumberOfTableValues</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">vals</span><span class="p">)))</span>
          <span class="n">lut</span><span class="o">.</span><span class="n">SetRange</span><span class="p">(</span><span class="n">scalarRange</span><span class="p">)</span>

          <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">vals</span><span class="p">))):</span>
              <span class="n">rgb</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
              <span class="n">dctf</span><span class="o">.</span><span class="n">GetColor</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">vals</span><span class="p">)),</span> <span class="n">rgb</span><span class="p">)</span>
              <span class="n">rgb</span> <span class="o">=</span> <span class="n">rgb</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
              <span class="nb">print</span> <span class="n">rgb</span>
              <span class="n">lut</span><span class="o">.</span><span class="n">SetTableValue</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">rgb</span><span class="p">)</span>
          <span class="n">lut</span><span class="o">.</span><span class="n">Build</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">lut</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkLookupTable</span><span class="p">()</span>
          <span class="n">lutNum</span> <span class="o">=</span> <span class="mi">256</span>
          <span class="n">lut</span><span class="o">.</span><span class="n">SetNumberOfTableValues</span><span class="p">(</span><span class="n">lutNum</span><span class="p">)</span>

          <span class="k">if</span> <span class="n">logScale</span><span class="p">:</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">vals</span> <span class="o">+</span> <span class="mf">0.000001</span>
            <span class="n">lut</span><span class="o">.</span><span class="n">SetScaleToLog10</span><span class="p">()</span>
            <span class="n">lut</span><span class="o">.</span><span class="n">SetRange</span><span class="p">(</span><span class="n">vals</span><span class="o">.</span><span class="n">min</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vals</span><span class="o">.</span><span class="n">max</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>

          <span class="n">ctf</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkColorTransferFunction</span><span class="p">()</span>
          <span class="n">ctf</span><span class="o">.</span><span class="n">SetColorSpaceToDiverging</span><span class="p">()</span>
          <span class="n">ctf</span><span class="o">.</span><span class="n">AddRGBPoint</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="c1"># Blue</span>
          <span class="n">ctf</span><span class="o">.</span><span class="n">AddRGBPoint</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># Red</span>
          <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">ss</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">lutNum</span><span class="p">)</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lutNum</span><span class="p">)]):</span>
          	<span class="n">cc</span> <span class="o">=</span> <span class="n">ctf</span><span class="o">.</span><span class="n">GetColor</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span>
          	<span class="n">lut</span><span class="o">.</span><span class="n">SetTableValue</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">cc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cc</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="c1"># Add the array to the PointData and set is as the active one for</span>
        <span class="c1"># plotting.</span>
        <span class="n">vtkPts</span> <span class="o">=</span> <span class="n">nps</span><span class="o">.</span><span class="n">numpy_to_vtk</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">array_type</span><span class="o">=</span><span class="n">vtk</span><span class="o">.</span><span class="n">VTK_FLOAT</span><span class="p">)</span>
        <span class="n">vtkPts</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s1">&#39;Colors&#39;</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">vtkPts</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">SetActiveScalars</span><span class="p">(</span><span class="s2">&quot;Colors&quot;</span><span class="p">)</span>

        <span class="c1"># TODO: Add to returnActors too</span>
        <span class="n">boaActors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">boaCoords</span><span class="p">:</span>
          <span class="n">sphereSource</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkSphereSource</span><span class="p">()</span>
          <span class="n">sphereSource</span><span class="o">.</span><span class="n">SetCenter</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
          <span class="n">sphereSource</span><span class="o">.</span><span class="n">SetRadius</span><span class="p">(</span><span class="mf">5.0</span><span class="p">)</span>
          <span class="n">mapper</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolyDataMapper</span><span class="p">()</span>
          <span class="n">mapper</span><span class="o">.</span><span class="n">SetInputConnection</span><span class="p">(</span><span class="n">sphereSource</span><span class="o">.</span><span class="n">GetOutputPort</span><span class="p">())</span>
          <span class="n">actor</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkActor</span><span class="p">()</span>
          <span class="n">actor</span><span class="o">.</span><span class="n">SetMapper</span><span class="p">(</span><span class="n">mapper</span><span class="p">)</span>
          <span class="n">boaActors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">actor</span><span class="p">)</span>

        <span class="c1"># Set colors for polydata object</span>
        <span class="n">mapper</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolyDataMapper</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">vtk</span><span class="o">.</span><span class="n">vtkVersion</span><span class="p">()</span><span class="o">.</span><span class="n">GetVTKVersion</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
          <span class="n">mapper</span><span class="o">.</span><span class="n">SetInputConnection</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">GetProducerPort</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">mapper</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="n">mapper</span><span class="o">.</span><span class="n">SetLookupTable</span><span class="p">(</span><span class="n">lut</span><span class="p">)</span>
        <span class="n">mapper</span><span class="o">.</span><span class="n">SetScalarRange</span><span class="p">(</span><span class="n">scalarRange</span><span class="p">)</span>

        <span class="c1"># Create actor</span>
        <span class="n">actor</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkActor</span><span class="p">()</span>
        <span class="n">actor</span><span class="o">.</span><span class="n">SetMapper</span><span class="p">(</span><span class="n">mapper</span><span class="p">)</span>

        <span class="c1"># Plot or return</span>
        <span class="k">if</span> <span class="n">return_actors</span><span class="p">:</span>
          <span class="k">return</span> <span class="n">actor</span>
        <span class="n">acts</span> <span class="o">=</span> <span class="p">[</span><span class="n">actor</span><span class="p">]</span>

        <span class="n">acts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">boaActors</span><span class="p">)</span></div>
        <span class="n">hf</span><span class="o">.</span><span class="n">render_actors</span><span class="p">(</span><span class="n">acts</span><span class="p">,</span> <span class="n">colorbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ruler</span><span class="o">=</span><span class="n">ruler</span><span class="p">,</span> <span class="n">bg</span> <span class="o">=</span> <span class="n">bg</span><span class="p">)</span>

    <span class="c1"># TODO:</span>
<div class="viewcode-block" id="AutoPhenotype.show_normals"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.AutoPhenotype.show_normals">[docs]</a>    <span class="k">def</span> <span class="nf">show_normals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverseNormals</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">onRatio</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">maxPoints</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">scaleFactor</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">return_actors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>

        <span class="n">mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span>

        <span class="c1"># Generate normals</span>
        <span class="n">normalGenerator</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolyDataNormals</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">vtk</span><span class="o">.</span><span class="n">vtkVersion</span><span class="p">()</span><span class="o">.</span><span class="n">GetVTKVersion</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
          <span class="n">normalGenerator</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">normalGenerator</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>

        <span class="n">normalGenerator</span><span class="o">.</span><span class="n">ComputePointNormalsOn</span><span class="p">()</span>
        <span class="n">normalGenerator</span><span class="o">.</span><span class="n">ComputeCellNormalsOff</span><span class="p">()</span>
        <span class="n">normalGenerator</span><span class="o">.</span><span class="n">SetSplitting</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># I want exactly one normal per vertex</span>
        <span class="n">normalGenerator</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">SetActiveNormals</span><span class="p">(</span><span class="s1">&#39;Normals&#39;</span><span class="p">)</span>
        <span class="n">normalGenerator</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>

        <span class="n">mapperNormals</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolyDataMapper</span><span class="p">()</span>
        <span class="n">mapperPoly</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolyDataMapper</span><span class="p">()</span>

        <span class="c1"># Don&#39;t necessarily plot every single pointss</span>
        <span class="n">maskPts</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkMaskPoints</span><span class="p">()</span>
        <span class="n">maskPts</span><span class="o">.</span><span class="n">SetOnRatio</span><span class="p">(</span><span class="n">onRatio</span><span class="p">)</span>
        <span class="n">maskPts</span><span class="o">.</span><span class="n">RandomModeOn</span><span class="p">()</span>
        <span class="n">maskPts</span><span class="o">.</span><span class="n">SetMaximumNumberOfPoints</span><span class="p">(</span><span class="n">maxPoints</span><span class="p">)</span>
        <span class="n">maskPts</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>

        <span class="n">reverse</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkReverseSense</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">reverseNormals</span><span class="p">:</span>
          <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">vtk</span><span class="o">.</span><span class="n">vtkVersion</span><span class="p">()</span><span class="o">.</span><span class="n">GetVTKVersion</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
            <span class="n">reverse</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="n">reverse</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>

          <span class="n">reverse</span><span class="o">.</span><span class="n">ReverseCellsOn</span><span class="p">()</span>
          <span class="n">reverse</span><span class="o">.</span><span class="n">ReverseNormalsOn</span><span class="p">()</span>
          <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">vtk</span><span class="o">.</span><span class="n">vtkVersion</span><span class="p">()</span><span class="o">.</span><span class="n">GetVTKVersion</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
            <span class="n">maskPts</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="n">reverse</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">())</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="n">maskPts</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">reverse</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">vtk</span><span class="o">.</span><span class="n">vtkVersion</span><span class="p">()</span><span class="o">.</span><span class="n">GetVTKVersion</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
            <span class="n">maskPts</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="n">maskPts</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>

        <span class="n">maskPts</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>

        <span class="n">arrow</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkArrowSource</span><span class="p">()</span>
        <span class="n">arrow</span><span class="o">.</span><span class="n">SetTipResolution</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">arrow</span><span class="o">.</span><span class="n">SetTipLength</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">arrow</span><span class="o">.</span><span class="n">SetTipRadius</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">arrow</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>

        <span class="c1"># use the output of vtkPolyDataNormals as input for the glyph3d</span>
        <span class="n">glyph</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkGlyph3D</span><span class="p">()</span>
        <span class="n">glyph</span><span class="o">.</span><span class="n">SetSourceConnection</span><span class="p">(</span><span class="n">arrow</span><span class="o">.</span><span class="n">GetOutputPort</span><span class="p">())</span>
        <span class="n">glyph</span><span class="o">.</span><span class="n">SetInputConnection</span><span class="p">(</span><span class="n">maskPts</span><span class="o">.</span><span class="n">GetOutputPort</span><span class="p">())</span>
        <span class="n">glyph</span><span class="o">.</span><span class="n">SetVectorModeToUseNormal</span><span class="p">()</span>
        <span class="n">glyph</span><span class="o">.</span><span class="n">SetScaleFactor</span><span class="p">(</span><span class="n">scaleFactor</span><span class="p">)</span>
        <span class="n">glyph</span><span class="o">.</span><span class="n">SetColorModeToColorByVector</span><span class="p">()</span>
        <span class="n">glyph</span><span class="o">.</span><span class="n">SetScaleModeToScaleByVector</span><span class="p">()</span>
        <span class="n">glyph</span><span class="o">.</span><span class="n">OrientOn</span><span class="p">()</span>
        <span class="n">glyph</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>

        <span class="n">mapperNormals</span><span class="o">.</span><span class="n">SetInputConnection</span><span class="p">(</span><span class="n">glyph</span><span class="o">.</span><span class="n">GetOutputPort</span><span class="p">())</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">vtk</span><span class="o">.</span><span class="n">vtkVersion</span><span class="p">()</span><span class="o">.</span><span class="n">GetVTKVersion</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
          <span class="n">mapperPoly</span><span class="o">.</span><span class="n">SetInputConnection</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">GetProducerPort</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">mapperPoly</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>

        <span class="c1"># Create actors</span>
        <span class="n">actorNormals</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkActor</span><span class="p">()</span>
        <span class="n">actorNormals</span><span class="o">.</span><span class="n">SetMapper</span><span class="p">(</span><span class="n">mapperNormals</span><span class="p">)</span>
        <span class="n">actorNormals</span><span class="o">.</span><span class="n">GetProperty</span><span class="p">()</span><span class="o">.</span><span class="n">SetOpacity</span><span class="p">(</span><span class="n">opacity</span><span class="p">)</span>
        <span class="n">actorPoly</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkActor</span><span class="p">()</span>
        <span class="n">actorPoly</span><span class="o">.</span><span class="n">SetMapper</span><span class="p">(</span><span class="n">mapperPoly</span><span class="p">)</span>
        <span class="n">actorPoly</span><span class="o">.</span><span class="n">GetProperty</span><span class="p">()</span><span class="o">.</span><span class="n">SetOpacity</span><span class="p">(</span><span class="n">opacity</span><span class="p">)</span>

        <span class="c1"># Create a renderer, render window, and interactor</span>
        <span class="k">if</span> <span class="n">return_actors</span><span class="p">:</span>
          <span class="k">return</span> <span class="p">[</span><span class="n">actorNormals</span><span class="p">,</span> <span class="n">actorPoly</span><span class="p">]</span></div>
        <span class="n">hf</span><span class="o">.</span><span class="n">render_actors</span><span class="p">([</span><span class="n">actorNormals</span><span class="p">,</span> <span class="n">actorPoly</span><span class="p">])</span>

<div class="viewcode-block" id="AutoPhenotype.show_curvatures"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.AutoPhenotype.show_curvatures">[docs]</a>    <span class="k">def</span> <span class="nf">show_curvatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">curv_types</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="n">operations</span><span class="o">=</span><span class="p">[],</span>
                        <span class="n">stdevs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">numColors</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">curvs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">normalise</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">log_</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_actors</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="c1">#        self = A</span>
<span class="c1">#        curv_types=[&#39;mean&#39;]</span>
<span class="c1">#        operations=[]</span>
<span class="c1">#        stdevs=2</span>
<span class="c1">#        numColors=2</span>
<span class="c1">#        curvs=curvs</span>
<span class="c1">#        normalise=False</span>
<span class="c1">#        log_=False</span>
<span class="c1">#        return_actors = False</span>

        <span class="c1"># TODO: This function needs a major rewrite</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolyData</span><span class="p">()</span>
        <span class="n">output</span><span class="o">.</span><span class="n">ShallowCopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
        <span class="n">polyAlg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">GetProducerPort</span><span class="p">()</span>

        <span class="n">curvaturesFilter</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkCurvatures</span><span class="p">()</span>
        <span class="n">curvaturesFilter</span><span class="o">.</span><span class="n">SetInputConnection</span><span class="p">(</span><span class="n">polyAlg</span><span class="p">)</span>

        <span class="c1"># Get curvature values</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">curvs</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calculate_curvatures</span><span class="p">(</span><span class="n">curv_types</span><span class="o">=</span><span class="n">curv_types</span><span class="p">,</span> <span class="n">operations</span><span class="o">=</span><span class="n">operations</span><span class="p">)</span>
            <span class="n">curvVals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curvature_type</span><span class="p">)</span>
            <span class="n">curvVals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">nps</span><span class="o">.</span><span class="n">vtk_to_numpy</span><span class="p">(</span><span class="n">curvVals</span><span class="p">))</span>
            <span class="n">curvs</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">curvs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">curvVals</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">curvs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">stdevs</span> <span class="o">!=</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="n">curvVals</span> <span class="o">=</span> <span class="n">hf</span><span class="o">.</span><span class="n">reject_outliers_2</span><span class="p">(</span><span class="n">curvVals</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="n">stdevs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">normalise</span><span class="p">:</span>
          <span class="n">min_</span> <span class="o">=</span> <span class="n">curvs</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
          <span class="n">max_</span> <span class="o">=</span> <span class="n">curvs</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
          <span class="n">curvVals</span> <span class="o">=</span> <span class="p">(</span><span class="n">curvVals</span> <span class="o">-</span> <span class="n">min_</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">max_</span> <span class="o">-</span> <span class="n">min_</span><span class="p">)</span>

        <span class="n">scalarRange</span> <span class="o">=</span> <span class="p">[</span><span class="n">curvVals</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">curvVals</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

        <span class="n">vtkarr</span> <span class="o">=</span> <span class="n">nps</span><span class="o">.</span><span class="n">numpy_to_vtk</span><span class="p">(</span>
                <span class="n">num_array</span><span class="o">=</span><span class="n">curvVals</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">array_type</span><span class="o">=</span><span class="n">vtk</span><span class="o">.</span><span class="n">VTK_DOUBLE</span><span class="p">)</span>
        <span class="n">vtkarr</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curvature_type</span><span class="p">)</span>
        <span class="n">curvaturesFilter</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">vtkarr</span><span class="p">)</span>
        <span class="n">curvaturesFilter</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">SetActiveScalars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curvature_type</span><span class="p">)</span>

        <span class="c1"># Create the color map</span>
        <span class="n">colorLookupTable</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkLookupTable</span><span class="p">()</span>
        <span class="n">colorLookupTable</span><span class="o">.</span><span class="n">SetTableRange</span><span class="p">(</span><span class="n">scalarRange</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">scalarRange</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="c1">#        colorLookupTable.SetNanColor(255, 255, 255, 0.0) # Set Nan-color to black</span>
        <span class="k">if</span> <span class="n">log_</span><span class="p">:</span>
          <span class="n">colorLookupTable</span><span class="o">.</span><span class="n">SetScaleToLog10</span><span class="p">()</span>
        <span class="n">colorLookupTable</span><span class="o">.</span><span class="n">Build</span><span class="p">()</span>

        <span class="c1"># Generate the colors for each point based on the color map</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkUnsignedCharArray</span><span class="p">()</span>
        <span class="n">colors</span><span class="o">.</span><span class="n">SetNumberOfComponents</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">colors</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Colors&quot;</span><span class="p">)</span>
        <span class="n">colors</span><span class="o">.</span><span class="n">SetLookupTable</span><span class="p">(</span><span class="n">colorLookupTable</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">curvs</span><span class="o">.</span><span class="n">median</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">()):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">curvVals</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Color nan values black or white depending on whether they are too big or too small</span>
            <span class="n">dcolor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
              <span class="k">if</span> <span class="n">curvs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">dcolor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">])</span>
              <span class="k">elif</span> <span class="n">curvs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">dcolor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span><span class="mf">1.</span><span class="p">,</span><span class="mf">1.</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
              <span class="n">colorLookupTable</span><span class="o">.</span><span class="n">GetColor</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">dcolor</span><span class="p">)</span>

            <span class="n">color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int16&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">color</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span> <span class="o">*</span> <span class="n">dcolor</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1.0</span>

            <span class="n">colors</span><span class="o">.</span><span class="n">InsertNextTupleValue</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>

        <span class="n">output</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">SetActiveScalars</span><span class="p">(</span><span class="s2">&quot;Colors&quot;</span><span class="p">)</span>

        <span class="n">mapper</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolyDataMapper</span><span class="p">()</span>
        <span class="n">mapper</span><span class="o">.</span><span class="n">SetInputConnection</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">GetProducerPort</span><span class="p">())</span>
        <span class="n">mapper</span><span class="o">.</span><span class="n">SetLookupTable</span><span class="p">(</span><span class="n">colorLookupTable</span><span class="p">)</span>

        <span class="c1"># Create actor</span>
        <span class="n">actor</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkActor</span><span class="p">()</span>
        <span class="n">actor</span><span class="o">.</span><span class="n">SetMapper</span><span class="p">(</span><span class="n">mapper</span><span class="p">)</span>

        <span class="c1"># TODO: Add colorbar as well</span>
        <span class="k">if</span> <span class="n">return_actors</span><span class="p">:</span>
          <span class="k">return</span> <span class="n">actor</span>
</div>
        <span class="n">hf</span><span class="o">.</span><span class="n">render_actors</span><span class="p">([</span><span class="n">actor</span><span class="p">],</span> <span class="n">colorbar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="AutoPhenotype.show_spheres_and_features"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.AutoPhenotype.show_spheres_and_features">[docs]</a>    <span class="k">def</span> <span class="nf">show_spheres_and_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">return_actors</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;&quot;3D visualisation of the sphere fit.</span>

<span class="sd">        Uses vtk to show the fitted spheres.</span>
<span class="sd">        Color coding:</span>
<span class="sd">            *White: first entry in self.results</span>
<span class="sd">            *R-&gt;G-&gt;B-&gt;P: following results</span>
<span class="sd">        Note: This makes the script pause at the position of the call. Closing</span>
<span class="sd">        the render window lets the script continue.</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        no return :</span>
<span class="sd">            Opens a render window.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span>
        <span class="n">numel</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
        <span class="n">spheres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[[</span><span class="s1">&#39;sphere_x_abs&#39;</span><span class="p">,</span> <span class="s1">&#39;sphere_y_abs&#39;</span><span class="p">,</span> <span class="s1">&#39;sphere_z_abs&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;sphere_radius&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()</span>
        <span class="n">sphereResolution</span> <span class="o">=</span> <span class="mi">50</span>
        <span class="n">spheresSources</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">spheres</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">spherevtk</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkSphereSource</span><span class="p">()</span>
            <span class="n">spherevtk</span><span class="o">.</span><span class="n">SetCenter</span><span class="p">(</span><span class="n">spheres</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">spheres</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">spheres</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
            <span class="n">spherevtk</span><span class="o">.</span><span class="n">SetRadius</span><span class="p">(</span><span class="n">spheres</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
            <span class="n">spherevtk</span><span class="o">.</span><span class="n">SetThetaResolution</span><span class="p">(</span><span class="n">sphereResolution</span><span class="p">)</span>
            <span class="n">spherevtk</span><span class="o">.</span><span class="n">SetPhiResolution</span><span class="p">(</span><span class="n">sphereResolution</span><span class="p">)</span>
            <span class="n">spherevtk</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
            <span class="n">spheresSources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spherevtk</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">())</span>
        <span class="n">sphereMappers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">featureMappers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Actors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">render</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkRenderer</span><span class="p">()</span>
        <span class="n">s_colors</span> <span class="o">=</span> <span class="n">rgb_list</span><span class="p">(</span><span class="n">numel</span><span class="p">,</span> <span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">))</span>
        <span class="n">f_colors</span> <span class="o">=</span> <span class="n">rgb_list</span><span class="p">(</span><span class="n">numel</span><span class="p">,</span> <span class="p">(</span><span class="o">.</span><span class="mi">7</span><span class="p">,</span> <span class="o">.</span><span class="mi">7</span><span class="p">,</span> <span class="o">.</span><span class="mi">7</span><span class="p">),</span> <span class="n">v</span><span class="o">=.</span><span class="mi">7</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numel</span><span class="p">):</span>
            <span class="n">s_mapper</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolyDataMapper</span><span class="p">()</span>
            <span class="n">s_mapper</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="n">spheresSources</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">s_mapper</span><span class="o">.</span><span class="n">ScalarVisibilityOff</span><span class="p">()</span>
            <span class="n">s_mapper</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
            <span class="n">sphereMappers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s_mapper</span><span class="p">)</span>
            <span class="n">f_mapper</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolyDataMapper</span><span class="p">()</span>
            <span class="n">f_mapper</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">f_mapper</span><span class="o">.</span><span class="n">ScalarVisibilityOff</span><span class="p">()</span>
            <span class="n">f_mapper</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
            <span class="n">featureMappers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f_mapper</span><span class="p">)</span>
            <span class="n">s_actor</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkActor</span><span class="p">()</span>
            <span class="n">s_actor</span><span class="o">.</span><span class="n">SetMapper</span><span class="p">(</span><span class="n">sphereMappers</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">s_actor</span><span class="o">.</span><span class="n">GetProperty</span><span class="p">()</span><span class="o">.</span><span class="n">SetColor</span><span class="p">(</span><span class="n">s_colors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">Actors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s_actor</span><span class="p">)</span>
            <span class="n">f_actor</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkActor</span><span class="p">()</span>
            <span class="n">f_actor</span><span class="o">.</span><span class="n">SetMapper</span><span class="p">(</span><span class="n">featureMappers</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">f_actor</span><span class="o">.</span><span class="n">GetProperty</span><span class="p">()</span><span class="o">.</span><span class="n">SetColor</span><span class="p">(</span><span class="n">f_colors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">Actors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f_actor</span><span class="p">)</span>
            <span class="n">render</span><span class="o">.</span><span class="n">AddActor</span><span class="p">(</span><span class="n">Actors</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">render</span><span class="o">.</span><span class="n">AddActor</span><span class="p">(</span><span class="n">Actors</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">return_actors</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">renderwindow</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkRenderWindow</span><span class="p">()</span>
            <span class="n">renderwindow</span><span class="o">.</span><span class="n">AddRenderer</span><span class="p">(</span><span class="n">render</span><span class="p">)</span>
            <span class="n">renderwindow</span><span class="o">.</span><span class="n">SetSize</span><span class="p">(</span><span class="mi">600</span><span class="p">,</span> <span class="mi">600</span><span class="p">)</span>
            <span class="n">interactrender</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkRenderWindowInteractor</span><span class="p">()</span>
            <span class="n">interactrender</span><span class="o">.</span><span class="n">SetRenderWindow</span><span class="p">(</span><span class="n">renderwindow</span><span class="p">)</span>
            <span class="n">interactrender</span><span class="o">.</span><span class="n">Initialize</span><span class="p">()</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkAxesActor</span><span class="p">()</span>
            <span class="n">widget</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkOrientationMarkerWidget</span><span class="p">()</span>
            <span class="n">widget</span><span class="o">.</span><span class="n">SetOutlineColor</span><span class="p">(</span><span class="mf">0.9300</span><span class="p">,</span> <span class="mf">0.5700</span><span class="p">,</span> <span class="mf">0.1300</span><span class="p">)</span>
            <span class="n">widget</span><span class="o">.</span><span class="n">SetOrientationMarker</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span>
            <span class="n">widget</span><span class="o">.</span><span class="n">SetInteractor</span><span class="p">(</span><span class="n">interactrender</span><span class="p">)</span>
            <span class="n">widget</span><span class="o">.</span><span class="n">SetViewport</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>
            <span class="n">widget</span><span class="o">.</span><span class="n">SetEnabled</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">widget</span><span class="o">.</span><span class="n">InteractiveOn</span><span class="p">()</span>
            <span class="n">render</span><span class="o">.</span><span class="n">ResetCamera</span><span class="p">()</span>
            <span class="n">renderwindow</span><span class="o">.</span><span class="n">Render</span><span class="p">()</span>
            <span class="n">interactrender</span><span class="o">.</span><span class="n">Start</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">return_actors</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span></div>
            <span class="k">return</span> <span class="n">Actors</span>

<div class="viewcode-block" id="AutoPhenotype.show_mesh"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.AutoPhenotype.show_mesh">[docs]</a>    <span class="k">def</span> <span class="nf">show_mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;&quot;Visualise the mesh.</span>

<span class="sd">        Uses vtk to visualise the mesh.</span>
<span class="sd">        This can be done before or after the segmentation (using</span>
<span class="sd">        self.curvatures_slice() ).</span>
<span class="sd">        Note: This makes the script pause at the position of the call. Closing</span>
<span class="sd">        the render window lets the script continue.</span>


<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        no return :</span>
<span class="sd">            Opens a render window.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>
        <span class="n">view_polydata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">),</span> <span class="p">(),</span> <span class="n">opacity</span><span class="o">=</span><span class="n">opacity</span><span class="p">)</span>

<div class="viewcode-block" id="AutoPhenotype.show_features"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.AutoPhenotype.show_features">[docs]</a>    <span class="k">def</span> <span class="nf">show_features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;&quot;___.</span>

<span class="sd">        Uses vtk to visualise the mesh.</span>
<span class="sd">        This can be done before or after the segmentation (using</span>
<span class="sd">        self.curvatures_slice() ).</span>
<span class="sd">        Note: This makes the script pause at the position of the call. Closing</span>
<span class="sd">        the render window lets the script continue.</span>


<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        no return :</span>
<span class="sd">            Opens a render window.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>
        <span class="n">view_polydata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">),</span> <span class="p">())</span>

<div class="viewcode-block" id="AutoPhenotype.load_mesh"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.AutoPhenotype.load_mesh">[docs]</a>    <span class="k">def</span> <span class="nf">load_mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">where</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; TODO DOCS &#39;&#39;&#39;</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPLYReader</span><span class="p">()</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">where</span><span class="p">)</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>

        <span class="n">plyMapper</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolyDataMapper</span><span class="p">()</span>
        <span class="n">plyMapper</span><span class="o">.</span><span class="n">SetInputConnection</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">GetOutputPort</span><span class="p">())</span>

        <span class="n">plyActor</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkActor</span><span class="p">()</span>
        <span class="n">plyActor</span><span class="o">.</span><span class="n">SetMapper</span><span class="p">(</span><span class="n">plyMapper</span><span class="p">)</span></div>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">plyActor</span><span class="o">.</span><span class="n">GetMapper</span><span class="p">()</span><span class="o">.</span><span class="n">GetInput</span><span class="p">()</span>

<div class="viewcode-block" id="AutoPhenotype.save_mesh_PLY"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.AutoPhenotype.save_mesh_PLY">[docs]</a>    <span class="k">def</span> <span class="nf">save_mesh_PLY</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">where</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; TODO DOCS &#39;&#39;&#39;</span>
        <span class="n">plyWriter</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPLYWriter</span><span class="p">()</span>
        <span class="n">plyWriter</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">where</span><span class="p">)</span>
        <span class="n">plyWriter</span><span class="o">.</span><span class="n">SetInputConnection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">GetProducerPort</span><span class="p">())</span></div>
        <span class="n">plyWriter</span><span class="o">.</span><span class="n">Write</span><span class="p">()</span>

<div class="viewcode-block" id="AutoPhenotype.load2"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.AutoPhenotype.load2">[docs]</a>    <span class="k">def</span> <span class="nf">load2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load data to existing AutoPhenotype Object.</span>

<span class="sd">        What is loaded can be specified.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        where : string, path</span>
<span class="sd">            Path to the folder from which the data should be loaded from.</span>

<span class="sd">        what : either None, logfile or list of strings</span>
<span class="sd">            *None: Logfile from specified folder is used.</span>
<span class="sd">            *logfile: No logfile is imported, instead the specified logfile is</span>
<span class="sd">                used. E.g. generated by create_logfile() function</span>
<span class="sd">            *list of strings: List of keywords specifying which data should be</span>
<span class="sd">                loaded. See logfile_from_str() for more information.</span>
<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        no return :</span>
<span class="sd">            Attributes are overwritten.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">what</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
            <span class="n">logfile</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">where</span> <span class="o">+</span> <span class="s1">&#39;/logfile.csv&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">what</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="n">create_logfile</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])):</span>
            <span class="n">logfile</span> <span class="o">=</span> <span class="n">what</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">what</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">([</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">]):</span>
            <span class="n">logfile</span> <span class="o">=</span> <span class="n">logfile_from_str</span><span class="p">(</span><span class="n">what</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39; - parameter what is unknown - &#39;</span>
            <span class="nb">print</span> <span class="s1">&#39;If logfile.csv exists in directory (where) use what=None&#39;</span>
            <span class="nb">print</span> <span class="s1">&#39;Else: either create logfile with create_logfile() function&#39;</span>
            <span class="nb">print</span> <span class="s1">&#39;or specify files to load with strings:&#39;</span>
            <span class="nb">print</span> <span class="s1">&#39;all, data, contour, mesh, features, results, tags&#39;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;parameter what is unknown&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">logfile</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">tiff</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">where</span> <span class="o">+</span> <span class="s2">&quot;/data.tif&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">ar</span> <span class="o">=</span> <span class="n">tiff</span><span class="o">.</span><span class="n">read_image</span><span class="p">()</span>
            <span class="n">tiff</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">ar</span>
<span class="c1">#            self.data, _ = tiffread(where + &#39;/data.tif&#39;)</span>
        <span class="k">if</span> <span class="n">logfile</span><span class="p">[</span><span class="s1">&#39;contour&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">tiff</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">where</span> <span class="o">+</span> <span class="s2">&quot;/contour.tif&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">ar</span> <span class="o">=</span> <span class="n">tiff</span><span class="o">.</span><span class="n">read_image</span><span class="p">()</span>
            <span class="n">tiff</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">contour</span> <span class="o">=</span> <span class="n">ar</span>
<span class="c1">#            self.contour, _ = tiffread(where + &#39;/contour.tif&#39;)</span>
        <span class="k">if</span> <span class="n">logfile</span><span class="p">[</span><span class="s1">&#39;mesh&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">meshreader</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataReader</span><span class="p">()</span>
            <span class="n">meshreader</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">where</span> <span class="o">+</span> <span class="s1">&#39;/mesh.vtp&#39;</span><span class="p">)</span>
            <span class="n">meshreader</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">PolyData</span><span class="p">(</span><span class="n">meshreader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">logfile</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">number_of_features</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">where</span> <span class="o">+</span> <span class="s1">&#39;/features&#39;</span><span class="p">))[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_features</span><span class="p">):</span>
                <span class="n">featurereader</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataReader</span><span class="p">()</span>
                <span class="n">featurereader</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">where</span> <span class="o">+</span> <span class="s1">&#39;/features/feature</span><span class="si">%s</span><span class="s1">.vtp&#39;</span>
                                          <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="n">featurereader</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolyData</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">DeepCopy</span><span class="p">(</span><span class="n">featurereader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">logfile</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span></div></div>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">where</span> <span class="o">+</span> <span class="s1">&#39;/results.csv&#39;</span><span class="p">)</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Functions</span>
<span class="sd">=========</span>
<span class="sd">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="setedges"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.setedges">[docs]</a><span class="k">def</span> <span class="nf">setedges</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set the edges of a 3D array to a specified value.</span>

<span class="sd">    Parameter</span>
<span class="sd">    ---------</span>
<span class="sd">    array : numpy array with shape() = (x,y,z)</span>
<span class="sd">        Array which edges are to be set to value.</span>

<span class="sd">    value : int, float</span>
<span class="sd">        Desired value for the edges of the array.</span>

<span class="sd">    Return:</span>
<span class="sd">    -------</span>
<span class="sd">    array : numpy array with shape() = (x,y,z)</span>
<span class="sd">        Input array with edges set to value.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">array</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="n">array</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="n">array</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">value</span></div>
    <span class="k">return</span> <span class="n">array</span>



<div class="viewcode-block" id="getedges"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.getedges">[docs]</a><span class="k">def</span> <span class="nf">getedges</span><span class="p">(</span><span class="n">shape</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a 3D numpy array with zeros on the edges and ones else.</span>

<span class="sd">    Used to suppress the fitting of edges by the smooth() function</span>
<span class="sd">    (ISoSI operator mask).</span>

<span class="sd">    Parameter</span>
<span class="sd">    ---------</span>
<span class="sd">    shape : tuple with three components</span>
<span class="sd">        Shape of the returned array</span>

<span class="sd">    Return:</span>
<span class="sd">    -------</span>
<span class="sd">    array : numpy array with shape() = shape</span>
<span class="sd">        Three dimensional numpy array with zeros on the edges and ones else.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">setedges</span><span class="p">(</span><span class="n">array</span><span class="p">)</span></div>
    <span class="k">return</span> <span class="n">array</span>


<div class="viewcode-block" id="setplanes"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.setplanes">[docs]</a><span class="k">def</span> <span class="nf">setplanes</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set the surface of a 3D array to a specified value.</span>

<span class="sd">    Parameter</span>
<span class="sd">    ---------</span>
<span class="sd">    array : numpy array with shape() = (x,y,z)</span>
<span class="sd">        Array which surface are to be set to value.</span>

<span class="sd">    value : int, float</span>
<span class="sd">        Desired value for the surface of the array.</span>

<span class="sd">    Return:</span>
<span class="sd">    -------</span>
<span class="sd">    array : numpy array with shape() = (x,y,z)</span>
<span class="sd">        Input array with surface set to value.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">array</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="n">array</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">value</span></div>
    <span class="n">array</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">value</span>


<div class="viewcode-block" id="getplanes"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.getplanes">[docs]</a><span class="k">def</span> <span class="nf">getplanes</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a 3D numpy array with zeros on the surface and ones else or the</span>
<span class="sd">    other way around.</span>

<span class="sd">    Used as initial contour for the AutoPhenotype.step() method.</span>

<span class="sd">    Parameter</span>
<span class="sd">    ---------</span>
<span class="sd">    shape : tuple with three components</span>
<span class="sd">        Shape of the returned array</span>

<span class="sd">    invert : bool</span>
<span class="sd">        *True: Ones on surface, zeros else</span>
<span class="sd">        *False: Zeros on surface, ones else</span>

<span class="sd">    Return:</span>
<span class="sd">    -------</span>
<span class="sd">    array : numpy array with shape() = shape</span>
<span class="sd">        Three dimensional numpy array with zeros on the surface and ones else</span>
<span class="sd">        or the other way around.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">invert</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">setplanes</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">invert</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">setplanes</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>
    <span class="k">return</span> <span class="n">array</span>


<div class="viewcode-block" id="fcycle"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.fcycle">[docs]</a><span class="k">class</span> <span class="nc">fcycle</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Call functions from the iterable each time it is called.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterable</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">funcs</span> <span class="o">=</span> <span class="n">cycle</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">funcs</span><span class="p">)</span></div>
        <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<div class="viewcode-block" id="SI"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.SI">[docs]</a><span class="k">def</span> <span class="nf">SI</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">iterate</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;SI operator.</span>

<span class="sd">    Marquez-Neila et al. 2014. (DOI: 10.1109/TPAMI.2013.106)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">P</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">9</span><span class="p">)]</span>
    <span class="n">P</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">P</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">P</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">P</span><span class="p">[</span><span class="mi">3</span><span class="p">][:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">P</span><span class="p">[</span><span class="mi">4</span><span class="p">][:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">P</span><span class="p">[</span><span class="mi">5</span><span class="p">][[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">P</span><span class="p">[</span><span class="mi">6</span><span class="p">][[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">:,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">P</span><span class="p">[</span><span class="mi">7</span><span class="p">][[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">P</span><span class="p">[</span><span class="mi">8</span><span class="p">][[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">_aux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">_aux</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">_aux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">P</span><span class="p">),)</span> <span class="o">+</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">P</span><span class="p">)):</span>
        <span class="n">_aux</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">binary_erosion</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">iterations</span><span class="o">=</span><span class="n">iterate</span><span class="p">,</span>
                                 <span class="n">mask</span><span class="o">=</span><span class="n">getedges</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">u</span><span class="p">)))</span></div>
    <span class="k">return</span> <span class="n">_aux</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>


<div class="viewcode-block" id="IS"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.IS">[docs]</a><span class="k">def</span> <span class="nf">IS</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">iterate</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;IS operator.</span>

<span class="sd">    Marquez-Neila et al. 2014. (DOI: 10.1109/TPAMI.2013.106)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">P</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">9</span><span class="p">)]</span>
    <span class="n">P</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">P</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">P</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">P</span><span class="p">[</span><span class="mi">3</span><span class="p">][:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">P</span><span class="p">[</span><span class="mi">4</span><span class="p">][:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">P</span><span class="p">[</span><span class="mi">5</span><span class="p">][[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">P</span><span class="p">[</span><span class="mi">6</span><span class="p">][[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">:,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">P</span><span class="p">[</span><span class="mi">7</span><span class="p">][[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">P</span><span class="p">[</span><span class="mi">8</span><span class="p">][[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">_aux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">_aux</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">_aux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">P</span><span class="p">),)</span> <span class="o">+</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">P</span><span class="p">)):</span>
        <span class="n">_aux</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">binary_dilation</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">iterations</span><span class="o">=</span><span class="n">iterate</span><span class="p">,</span>
                                  <span class="n">mask</span><span class="o">=</span><span class="n">getedges</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">u</span><span class="p">)))</span></div>
    <span class="k">return</span> <span class="n">_aux</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>


<div class="viewcode-block" id="SIoIS"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.SIoIS">[docs]</a><span class="k">def</span> <span class="nf">SIoIS</span><span class="p">(</span><span class="n">u</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;SIoIS operator.</span>

<span class="sd">    Marquez-Neila et al. 2014. (DOI: 10.1109/TPAMI.2013.106)</span>
<span class="sd">    &quot;&quot;&quot;</span></div>
    <span class="k">return</span> <span class="n">SI</span><span class="p">(</span><span class="n">IS</span><span class="p">(</span><span class="n">u</span><span class="p">))</span>


<div class="viewcode-block" id="ISoSI"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.ISoSI">[docs]</a><span class="k">def</span> <span class="nf">ISoSI</span><span class="p">(</span><span class="n">u</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;ISoSI operator.</span>

<span class="sd">    Marquez-Neila et al. 2014. (DOI: 10.1109/TPAMI.2013.106)</span>
<span class="sd">    &quot;&quot;&quot;</span></div>
    <span class="k">return</span> <span class="n">IS</span><span class="p">(</span><span class="n">SI</span><span class="p">(</span><span class="n">u</span><span class="p">))</span>


<div class="viewcode-block" id="sort_a_along_b"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.sort_a_along_b">[docs]</a><span class="k">def</span> <span class="nf">sort_a_along_b</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return list &#39;a&#39; sorted following the sorting of list &#39;b&#39;.</span>

<span class="sd">    List &#39;b&#39; is sorted from low to high values. Elements in &#39;a&#39; follow the</span>
<span class="sd">    sorting in list &#39;b&#39;.</span>
<span class="sd">    Example:  to array</span>
<span class="sd">        a = [p,c,e,s,e,i,l]; b = [5,2,7,6,1,4,3]</span>
<span class="sd">        -&gt; sort_a_along_b(a,b) = [e,c,l,i,p,s,e];</span>
<span class="sd">        # and b would be [1,2,3,4,5,6,7]</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    a : list (same length as b)</span>
<span class="sd">        List to be sorted.</span>

<span class="sd">    b : list (same length as a)</span>
<span class="sd">        Reference list for sorting.</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    a&#39; : list</span>
<span class="sd">        List &#39;a&#39; sorted with respect to &#39;b&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span></div>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)))[:,</span> <span class="mi">1</span><span class="p">]</span>


<div class="viewcode-block" id="fit_sphere"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.fit_sphere">[docs]</a><span class="k">def</span> <span class="nf">fit_sphere</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Fit a sphere to specified data.</span>

<span class="sd">    Uses a least square fit for optimisation.</span>
<span class="sd">    Return coordinates of the sphere center and its radius as well as the</span>
<span class="sd">    residual variance of the fit.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : 3D numpy array</span>
<span class="sd">        Data to be fit with a sphere</span>

<span class="sd">    init : list</span>
<span class="sd">        List of initial parameters:</span>
<span class="sd">        [x0, y0, z0, r0]</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    parameter : list</span>
<span class="sd">        list of fitted parameters and residual variance:</span>
<span class="sd">        [x,y,z,r,res_var]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">fitfunc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">coords</span><span class="p">):</span>
        <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">p</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">T</span>
        <span class="k">return</span> <span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">z</span> <span class="o">-</span> <span class="n">z0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">errfunc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="n">fitfunc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">**</span><span class="mf">2.</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">data</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">p1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">leastsq</span><span class="p">(</span><span class="n">errfunc</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">index</span><span class="p">,))</span>
    <span class="n">p1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>
    <span class="c1"># res_var</span>
    <span class="n">p1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">index</span> <span class="o">-</span> <span class="n">p1</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">-</span> <span class="n">p1</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span></div>
    <span class="k">return</span> <span class="n">p1</span>


<div class="viewcode-block" id="fit_paraboloid"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.fit_paraboloid">[docs]</a><span class="k">def</span> <span class="nf">fit_paraboloid</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Fit a paraboloid to arbitrarily oriented 3D data.</span>

<span class="sd">    The paraboloid data can by oriented along an arbitrary axis. Not neccesary</span>
<span class="sd">    x,y,z. The function rotates the data points and returns the rotation angles</span>
<span class="sd">    along the x,y,z axis.</span>
<span class="sd">    Returns the parameters for a praboloid along the z-axis. The angles can be</span>
<span class="sd">    used to correct the paraboloid for rotation.</span>
<span class="sd">    Paraboloid equation : p1*x**2.+p2*y**2.+p3*x+p4*y+p5 = z</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : array or list of cartesian coordinates</span>
<span class="sd">        Cartesian coordinates of the data points.</span>

<span class="sd">    init : list of 8 scalars</span>
<span class="sd">        Initial parameter set.</span>
<span class="sd">        [p1, p2, p3, p4, p5, alpha, beta, gamma]</span>
<span class="sd">        *alpha: rotation around x axis</span>
<span class="sd">        *beta: rotation around y axis</span>
<span class="sd">        *gamma: rotation around z axis</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    popt : list of 8 scalars</span>
<span class="sd">        Optimised parameters.</span>
<span class="sd">        [p1, p2, p3, p4, p5, alpha, beta, gamma]</span>
<span class="sd">        *alpha: rotation around x axis</span>
<span class="sd">        *beta: rotation around y axis</span>
<span class="sd">        *gamma: rotation around z axis</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">errfunc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">coord</span><span class="p">):</span>
        <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">p3</span><span class="p">,</span> <span class="n">p4</span><span class="p">,</span> <span class="n">p5</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">=</span> <span class="n">p</span>
        <span class="n">coord</span> <span class="o">=</span> <span class="n">rot_coord</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="p">[</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">])</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p1</span> <span class="o">*</span> <span class="n">x</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="n">p2</span> <span class="o">*</span> <span class="n">y</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="n">p3</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">p4</span> <span class="o">*</span> <span class="n">y</span> <span class="o">+</span> <span class="n">p5</span> <span class="o">-</span> <span class="n">z</span><span class="p">)</span>
<span class="c1">#         return p1*x**2.+p2*y**2.+p3*x*y+p4*x+p5*y+p6 - z</span>
    <span class="n">popt</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">leastsq</span><span class="p">(</span><span class="n">errfunc</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">data</span><span class="p">,))</span></div>
    <span class="k">return</span> <span class="n">popt</span>


<div class="viewcode-block" id="fit_paraboloid_weighted"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.fit_paraboloid_weighted">[docs]</a><span class="k">def</span> <span class="nf">fit_paraboloid_weighted</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]):</span>

    <span class="c1"># TODO: write docs</span>
    <span class="k">def</span> <span class="nf">errfunc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">coord</span><span class="p">):</span>
        <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">p3</span><span class="p">,</span> <span class="n">p4</span><span class="p">,</span> <span class="n">p5</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">=</span> <span class="n">p</span>
        <span class="n">coord</span> <span class="o">=</span> <span class="n">rot_coord</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="p">[</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">])</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># Calculate the top of the paraboloid</span>
        <span class="n">tx</span> <span class="o">=</span> <span class="o">-</span><span class="n">p3</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">p1</span><span class="p">)</span>
        <span class="n">ty</span> <span class="o">=</span> <span class="o">-</span><span class="n">p4</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">p2</span><span class="p">)</span>
        <span class="n">tz</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">*</span> <span class="n">tx</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="n">p2</span> <span class="o">*</span> <span class="n">ty</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="n">p3</span> <span class="o">*</span> <span class="n">tx</span> <span class="o">+</span> <span class="n">p4</span> <span class="o">*</span> <span class="n">ty</span> <span class="o">+</span> <span class="n">p5</span>

        <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p1</span> <span class="o">*</span> <span class="n">x</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="n">p2</span> <span class="o">*</span> <span class="n">y</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="n">p3</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">p4</span> <span class="o">*</span> <span class="n">y</span> <span class="o">+</span> <span class="n">p5</span> <span class="o">-</span> <span class="n">z</span><span class="p">)</span>

    <span class="n">popt</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">leastsq</span><span class="p">(</span><span class="n">errfunc</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">data</span><span class="p">,))</span></div>
    <span class="k">return</span> <span class="n">popt</span>


<div class="viewcode-block" id="get_paraboloid_apex"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.get_paraboloid_apex">[docs]</a><span class="k">def</span> <span class="nf">get_paraboloid_apex</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the apex of a paraboloid.</span>

<span class="sd">    Use the return of fit_paraboloid() to compute the apex of the paraboloid.</span>
<span class="sd">    The return is in the coordinate system of the data, meaning that the</span>
<span class="sd">    coordinates have been corected for the rotation angles.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    p : list of 8 scalars</span>
<span class="sd">        Optimised parameters.</span>
<span class="sd">        [p1, p2, p3, p4, p5, alpha, beta, gamma]</span>
<span class="sd">        *alpha: rotation around x axis</span>
<span class="sd">        *beta: rotation around y axis</span>
<span class="sd">        *gamma: rotation around z axis</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    coord : list</span>
<span class="sd">        List of the apex&#39; [x,y,z] coordinates.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">p3</span><span class="p">,</span> <span class="n">p4</span><span class="p">,</span> <span class="n">p5</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">=</span> <span class="n">p</span>
    <span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="n">p3</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">p1</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="n">p4</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">p2</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">*</span> <span class="n">x</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="n">p2</span> <span class="o">*</span> <span class="n">y</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="n">p3</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">p4</span> <span class="o">*</span> <span class="n">y</span> <span class="o">+</span> <span class="n">p5</span></div>
    <span class="k">return</span> <span class="n">rot_coord</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">],</span> <span class="p">]),</span> <span class="p">[</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">],</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>


<div class="viewcode-block" id="rot_coord"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.rot_coord">[docs]</a><span class="k">def</span> <span class="nf">rot_coord</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">angles</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Rotate given coordinates by specified angles.</span>

<span class="sd">    Use rotation matrices to rotate a list of coordinates around the x,y,z axis</span>
<span class="sd">    by specified angles alpha,beta,gamma.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    coord : list of coordinates</span>
<span class="sd">        List of catesian coordinates</span>

<span class="sd">    angles : list of three scalars</span>
<span class="sd">        List specifying the rotation angles. See description.</span>

<span class="sd">    invert : boolean</span>
<span class="sd">        True inverts the used rotation matrix. This can be used for undoing a</span>
<span class="sd">        rotation.</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    rotated_coord : list of cordinates</span>
<span class="sd">        List of rotated cartesian coordinates</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">=</span> <span class="n">angles</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">coord</span><span class="p">))</span>
    <span class="n">Rx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                   <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alpha</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alpha</span><span class="p">)],</span>
                   <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alpha</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alpha</span><span class="p">)]])</span>
    <span class="n">Ry</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">beta</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">beta</span><span class="p">)],</span>
                   <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                   <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">beta</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">beta</span><span class="p">)]])</span>
    <span class="n">Rz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">gamma</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">gamma</span><span class="p">),</span> <span class="mi">0</span><span class="p">],</span>
                   <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">gamma</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">gamma</span><span class="p">),</span> <span class="mi">0</span><span class="p">],</span>
                   <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>

    <span class="k">if</span> <span class="n">invert</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">Rz</span><span class="p">,</span> <span class="n">Ry</span><span class="p">),</span> <span class="n">Rx</span><span class="p">))</span>
<span class="c1">#        R = np.linalg.inv(Rx.dot(Ry.dot(Rz)))</span>
    <span class="k">elif</span> <span class="n">invert</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">Rz</span><span class="p">,</span> <span class="n">Ry</span><span class="p">),</span> <span class="n">Rx</span><span class="p">)</span>
<span class="c1">#        R = Rx.dot(Ry.dot(Rz))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">coord</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">xyz</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coord</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]))</span></div>
    <span class="k">return</span> <span class="n">xyz</span>


<div class="viewcode-block" id="rot_matrix_44"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.rot_matrix_44">[docs]</a><span class="k">def</span> <span class="nf">rot_matrix_44</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1"># TODO: Write docs</span>
    <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">=</span> <span class="n">angles</span>
    <span class="n">Rx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                   <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alpha</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alpha</span><span class="p">),</span> <span class="mi">0</span><span class="p">],</span>
                   <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alpha</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alpha</span><span class="p">),</span> <span class="mi">0</span><span class="p">],</span>
                   <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
    <span class="n">Ry</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">beta</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">beta</span><span class="p">),</span> <span class="mi">0</span><span class="p">],</span>
                   <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                   <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">beta</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">beta</span><span class="p">),</span> <span class="mi">0</span><span class="p">],</span>
                   <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
    <span class="n">Rz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">gamma</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">gamma</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                   <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">gamma</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">gamma</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                   <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                   <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>

    <span class="k">if</span> <span class="n">invert</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">Rz</span><span class="p">,</span> <span class="n">Ry</span><span class="p">),</span> <span class="n">Rx</span><span class="p">))</span>
<span class="c1">#        R = np.linalg.inv(Rx.dot(Ry.dot(Rz)))</span>
    <span class="k">elif</span> <span class="n">invert</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">Rz</span><span class="p">,</span> <span class="n">Ry</span><span class="p">),</span> <span class="n">Rx</span><span class="p">)</span>
<span class="c1">#        R = Rx.dot(Ry.dot(Rz))</span>
</div>
    <span class="k">return</span> <span class="n">R</span>


<div class="viewcode-block" id="cart2sphere"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.cart2sphere">[docs]</a><span class="k">def</span> <span class="nf">cart2sphere</span><span class="p">(</span><span class="n">xyz</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert cartesian coordinates into spherical coordinates.</span>

<span class="sd">    Convert a list of cartesian coordinates x,y,z to spherical coordinates</span>
<span class="sd">    r,theta,phi. theta is defined as 0 along z-axis.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    xyz : list</span>
<span class="sd">        List of cartesian coordinates</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    rtp : list</span>
<span class="sd">        List of spherical coordinates</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rtp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">xyz</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">xy</span> <span class="o">=</span> <span class="n">xyz</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">xyz</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">rtp</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xy</span> <span class="o">+</span> <span class="n">xyz</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">rtp</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xy</span><span class="p">),</span> <span class="n">xyz</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="n">rtp</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">xyz</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">xyz</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span></div>
    <span class="k">return</span> <span class="n">rtp</span>


<div class="viewcode-block" id="sphere2cart"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.sphere2cart">[docs]</a><span class="k">def</span> <span class="nf">sphere2cart</span><span class="p">(</span><span class="n">rtp</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert spherical coordinates into cartesian coordinates.</span>

<span class="sd">    Convert a list of spherical coordinates r,theta,phi to cartesian coordinates</span>
<span class="sd">    x,y,z. theta is defined as 0 along z-axis.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rtp : list</span>
<span class="sd">        List of spherical coordinates</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    xyz : list</span>
<span class="sd">        List of cartesian coordinates</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">rtp</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">xyz</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rtp</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rtp</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rtp</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="n">xyz</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rtp</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rtp</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rtp</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="n">xyz</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">rtp</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rtp</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span></div>
    <span class="k">return</span> <span class="n">xyz</span>


<div class="viewcode-block" id="array_from_vtk_polydata"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.array_from_vtk_polydata">[docs]</a><span class="k">def</span> <span class="nf">array_from_vtk_polydata</span><span class="p">(</span><span class="n">poly</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&quot;&quot;&quot;Create a boolean numpy array from vtkPolyData.</span>

<span class="sd">    The size of the created numpy array can be specified. It has to be equal or</span>
<span class="sd">    larger than the bounds of the polydata. Scalar values in the polyData are</span>
<span class="sd">    ignored. All nonzero values in poly are transformed into ones in the return.</span>
<span class="sd">    Note: works only in 3D.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    poly : vtkPolyData (3D)</span>
<span class="sd">        polyData to be transformed.</span>

<span class="sd">    size : tuple / list of int</span>
<span class="sd">        Size of the created numpy array. By default set to the boundd of the</span>
<span class="sd">        polyData. e.g. (3,4,5)</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    array : numpy array</span>
<span class="sd">        Boolean numpy array corresponding to the nonzero points in poly.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">([]):</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">poly</span><span class="o">.</span><span class="n">GetPoints</span><span class="p">()</span><span class="o">.</span><span class="n">GetBounds</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vtk_to_numpy</span><span class="p">(</span><span class="n">poly</span><span class="o">.</span><span class="n">GetPoints</span><span class="p">()</span><span class="o">.</span><span class="n">GetData</span><span class="p">()),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
    <span class="n">out</span><span class="p">[</span><span class="n">indices</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">indices</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">indices</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span></div>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>


<div class="viewcode-block" id="polydata_to_coord"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.polydata_to_coord">[docs]</a><span class="k">def</span> <span class="nf">polydata_to_coord</span><span class="p">(</span><span class="n">poly</span><span class="p">):</span>
    <span class="c1"># Write all of the coordinates of the points in the vtkPolyData to the console.</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">poly</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">(),</span> <span class="mi">3</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">poly</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">()):</span>
        <span class="n">data</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">poly</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
</div>
    <span class="k">return</span> <span class="n">data</span>


<div class="viewcode-block" id="coord_to_polydata"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.coord_to_polydata">[docs]</a><span class="k">def</span> <span class="nf">coord_to_polydata</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">vtk_data_array</span> <span class="o">=</span> <span class="n">numpy_support</span><span class="o">.</span><span class="n">numpy_to_vtk</span><span class="p">(</span>
        <span class="n">num_array</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">array_type</span><span class="o">=</span><span class="n">vtk</span><span class="o">.</span><span class="n">VTK_FLOAT</span><span class="p">)</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPoints</span><span class="p">()</span>
    <span class="n">points</span><span class="o">.</span><span class="n">SetData</span><span class="p">(</span><span class="n">vtk_data_array</span><span class="p">)</span></div>
    <span class="k">return</span> <span class="n">points</span>
<span class="c1">#    for ii in xrange(idNumPointsInFile):</span>
<span class="c1">#        value = array.GetValue(ii)</span>

<div class="viewcode-block" id="view_polydata"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.view_polydata">[docs]</a><span class="k">def</span> <span class="nf">view_polydata</span><span class="p">(</span><span class="n">poly</span><span class="p">,</span> <span class="n">firstcolor</span><span class="o">=</span><span class="p">(),</span> <span class="n">lastcolor</span><span class="o">=</span><span class="p">(),</span> <span class="n">return_actors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">bg</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;Display vtkPolyData. Can show superposition of many vtkPolyData.</span>

<span class="sd">    If input is a list of vtkPolyData, displays all of them in one viewer.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    poly : vtkPolyData (3D) / list of vtkPolyData (3D)</span>
<span class="sd">        polyData to be displayed. List or single polydata.</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    no return :</span>
<span class="sd">        Opens render window.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span> <span class="o">==</span> <span class="p">():</span>
        <span class="n">numel</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">poly</span> <span class="o">=</span> <span class="p">[</span><span class="n">poly</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">numel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">poly</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">firstcolor</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(())</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span>
            <span class="n">lastcolor</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(()):</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">rgb_list</span><span class="p">(</span><span class="n">numel</span><span class="p">,</span> <span class="n">firstcolor</span><span class="o">=</span><span class="n">firstcolor</span><span class="p">,</span> <span class="n">lastcolor</span><span class="o">=</span><span class="n">lastcolor</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">firstcolor</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(()):</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">rgb_list</span><span class="p">(</span><span class="n">numel</span><span class="p">,</span> <span class="n">firstcolor</span><span class="o">=</span><span class="n">firstcolor</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">lastcolor</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(()):</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">rgb_list</span><span class="p">(</span><span class="n">numel</span><span class="p">,</span> <span class="n">lastcolor</span><span class="o">=</span><span class="n">lastcolor</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">rgb_list</span><span class="p">(</span><span class="n">numel</span><span class="p">)</span>
    <span class="n">Mappers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">Actors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">render</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkRenderer</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numel</span><span class="p">):</span>
        <span class="n">mapper</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolyDataMapper</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">vtk</span><span class="o">.</span><span class="n">vtkVersion</span><span class="p">()</span><span class="o">.</span><span class="n">GetVTKVersion</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
          <span class="n">mapper</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="n">poly</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">mapper</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">poly</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">mapper</span><span class="o">.</span><span class="n">ScalarVisibilityOff</span><span class="p">()</span>
        <span class="n">mapper</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
        <span class="n">Mappers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mapper</span><span class="p">)</span>
        <span class="n">actor</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkActor</span><span class="p">()</span>
        <span class="n">actor</span><span class="o">.</span><span class="n">SetMapper</span><span class="p">(</span><span class="n">Mappers</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">actor</span><span class="o">.</span><span class="n">GetProperty</span><span class="p">()</span><span class="o">.</span><span class="n">SetColor</span><span class="p">(</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">actor</span><span class="o">.</span><span class="n">GetProperty</span><span class="p">()</span><span class="o">.</span><span class="n">SetOpacity</span><span class="p">(</span><span class="n">opacity</span><span class="p">)</span>
        <span class="n">Actors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">actor</span><span class="p">)</span>
        <span class="n">render</span><span class="o">.</span><span class="n">AddActor</span><span class="p">(</span><span class="n">Actors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">return_actors</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">render</span><span class="o">.</span><span class="n">SetBackground</span><span class="p">(</span><span class="n">bg</span><span class="p">)</span>
        <span class="n">renderwindow</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkRenderWindow</span><span class="p">()</span>
        <span class="n">renderwindow</span><span class="o">.</span><span class="n">AddRenderer</span><span class="p">(</span><span class="n">render</span><span class="p">)</span>
        <span class="n">renderwindow</span><span class="o">.</span><span class="n">SetSize</span><span class="p">(</span><span class="mi">1200</span><span class="p">,</span> <span class="mi">1200</span><span class="p">)</span>
        <span class="n">interactrender</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkRenderWindowInteractor</span><span class="p">()</span>
        <span class="n">interactrender</span><span class="o">.</span><span class="n">SetRenderWindow</span><span class="p">(</span><span class="n">renderwindow</span><span class="p">)</span>
        <span class="n">interactrender</span><span class="o">.</span><span class="n">Initialize</span><span class="p">()</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkAxesActor</span><span class="p">()</span>
        <span class="n">widget</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkOrientationMarkerWidget</span><span class="p">()</span>
        <span class="n">widget</span><span class="o">.</span><span class="n">SetOutlineColor</span><span class="p">(</span><span class="mf">0.9300</span><span class="p">,</span> <span class="mf">0.5700</span><span class="p">,</span> <span class="mf">0.1300</span><span class="p">)</span>
        <span class="n">widget</span><span class="o">.</span><span class="n">SetOrientationMarker</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span>
        <span class="n">widget</span><span class="o">.</span><span class="n">SetInteractor</span><span class="p">(</span><span class="n">interactrender</span><span class="p">)</span>
        <span class="n">widget</span><span class="o">.</span><span class="n">SetViewport</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>
        <span class="n">widget</span><span class="o">.</span><span class="n">SetEnabled</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">widget</span><span class="o">.</span><span class="n">InteractiveOn</span><span class="p">()</span>
        <span class="n">render</span><span class="o">.</span><span class="n">ResetCamera</span><span class="p">()</span>
        <span class="n">renderwindow</span><span class="o">.</span><span class="n">Render</span><span class="p">()</span>
        <span class="n">interactrender</span><span class="o">.</span><span class="n">Start</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">return_actors</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span></div>
        <span class="k">return</span> <span class="n">Actors</span>


<div class="viewcode-block" id="rgb_list"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.rgb_list">[docs]</a><span class="k">def</span> <span class="nf">rgb_list</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">firstcolor</span><span class="o">=</span><span class="p">(),</span> <span class="n">lastcolor</span><span class="o">=</span><span class="p">(),</span> <span class="n">s</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate a list of N distinct RGB tuples.</span>

<span class="sd">    The first and last entry of the list can be specified. The list will still</span>
<span class="sd">    have N entries. The range of each tuple entry is between 0. and 1. The list</span>
<span class="sd">    goes from red over green to blue and purple.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    N : int</span>
<span class="sd">        Number of returned RGB-tuples.</span>

<span class="sd">    firstcolor : list, three components</span>
<span class="sd">        First entry of the returned RGB-list.</span>

<span class="sd">    lastcolor : list, three components</span>
<span class="sd">        Last entry of the returned RGB-list.</span>

<span class="sd">    s : float between 0 and 1</span>
<span class="sd">        Saturation value of the list</span>

<span class="sd">    v : float between 0 and 1</span>
<span class="sd">        Value value of the list</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    RGB-list : list of tuples with three components</span>
<span class="sd">        List with N RGB-tuples</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">firstcolor</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">lastcolor</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">HSV_tuples</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)]</span>
        <span class="n">RGB_tuples</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">colorsys</span><span class="o">.</span><span class="n">hsv_to_rgb</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">),</span> <span class="n">HSV_tuples</span><span class="p">)</span>
        <span class="n">RGB_tuples</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">firstcolor</span><span class="p">)</span>
        <span class="n">RGB_tuples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lastcolor</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">firstcolor</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">HSV_tuples</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="n">RGB_tuples</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">colorsys</span><span class="o">.</span><span class="n">hsv_to_rgb</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">),</span> <span class="n">HSV_tuples</span><span class="p">)</span>
        <span class="n">RGB_tuples</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">firstcolor</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">lastcolor</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">HSV_tuples</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="n">RGB_tuples</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">colorsys</span><span class="o">.</span><span class="n">hsv_to_rgb</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">),</span> <span class="n">HSV_tuples</span><span class="p">)</span>
        <span class="n">RGB_tuples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lastcolor</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">HSV_tuples</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
        <span class="n">RGB_tuples</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">colorsys</span><span class="o">.</span><span class="n">hsv_to_rgb</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">),</span> <span class="n">HSV_tuples</span><span class="p">)</span></div>
    <span class="k">return</span> <span class="n">RGB_tuples</span>


<div class="viewcode-block" id="sphere_volume"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.sphere_volume">[docs]</a><span class="k">def</span> <span class="nf">sphere_volume</span><span class="p">(</span><span class="n">radius</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the volume of a sphere.</span>

<span class="sd">    Is able to process numpy arrays.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    R : ndarray of floats</span>
<span class="sd">        Radi of spheres.</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    Volumes : ndarray of floats</span>
<span class="sd">        Volumes of spheres.</span>
<span class="sd">    &quot;&quot;&quot;</span></div>
    <span class="k">return</span> <span class="mf">4.</span> <span class="o">/</span> <span class="mf">3.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">radius</span><span class="o">**</span><span class="mf">3.</span>


<div class="viewcode-block" id="angle_difference"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.angle_difference">[docs]</a><span class="k">def</span> <span class="nf">angle_difference</span><span class="p">(</span><span class="n">array</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the differences between consecutive angles in an array.</span>

<span class="sd">    Computes both clockwise and counterclockwise angle differences.</span>
<span class="sd">    Angles need to be in degree.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    array : list with n entries</span>
<span class="sd">        List of angles.</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    angle differences : list with two entries each with n-1 entries</span>
<span class="sd">        *return[0]: clockwise angle differences</span>
<span class="sd">        *return[1]: counterclockwise angle differences</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">clockwise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ediff1d</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> <span class="o">%</span> <span class="mf">360.</span>
    <span class="n">counterclockwise</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="mf">360.</span> <span class="o">-</span> <span class="n">clockwise</span><span class="p">)</span></div>
    <span class="k">return</span> <span class="n">clockwise</span><span class="p">,</span> <span class="n">counterclockwise</span>


<div class="viewcode-block" id="create_logfile"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.create_logfile">[docs]</a><span class="k">def</span> <span class="nf">create_logfile</span><span class="p">(</span><span class="n">logs</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a logfile for saving and loading AutoPhenotype data from boolean</span>
<span class="sd">    list.</span>

<span class="sd">    Return logfile and optionally save it as .csv file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    logs : list of 1,0</span>
<span class="sd">        Has to have six entries. 0: deactivated, 1: activated</span>
<span class="sd">            *Entry 0: data</span>
<span class="sd">            *Entry 1: contour</span>
<span class="sd">            *Entry 2: mesh</span>
<span class="sd">            *Entry 3: features</span>
<span class="sd">            *Entry 4: results</span>
<span class="sd">            *Entry 5: tags</span>

<span class="sd">    path = string</span>
<span class="sd">        If specified, the logfile is created at the specified location as .csv</span>
<span class="sd">        file. Path has to include file name.</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    logfile : logfile</span>
<span class="sd">        Logfile which can be used in saving, loading AutoPhenotype data. Format</span>
<span class="sd">        is pandas.DataFrame()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logfile</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">logs</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;contour&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;mesh&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;features&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;results&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;tags&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">logfile</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">):</span>
        <span class="n">logfile</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>
        <span class="k">return</span> <span class="n">logfile</span>


<div class="viewcode-block" id="logfile_from_str"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.logfile_from_str">[docs]</a><span class="k">def</span> <span class="nf">logfile_from_str</span><span class="p">(</span><span class="n">what</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a logfile for saving and loading AutoPhenotype data from keywords</span>

<span class="sd">    Uses keywords to generate a logfile. Keywords can be:</span>
<span class="sd">        *&#39;all&#39;: everything below</span>
<span class="sd">        *&#39;data&#39;: input data as .tif</span>
<span class="sd">        *&#39;contour&#39;: contour fit as .tif</span>
<span class="sd">        *&#39;mesh&#39;: mesh as vtk data .vtp</span>
<span class="sd">        *&#39;features&#39;: features as vtk data .vtp</span>
<span class="sd">        *&#39;results&#39;: results as .csv</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    what : list of strings</span>
<span class="sd">        Use specified strings from description.</span>
<span class="sd">        Note: has to be list, even if only one keyword is specified.</span>

<span class="sd">    path = string</span>
<span class="sd">        If specified, the logfile is created at the specified location as .csv</span>
<span class="sd">        file. Path has to include file name.</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    logfile : logfile</span>
<span class="sd">        Logfile which can be used in saving, loading AutoPhenotype data. Format</span>
<span class="sd">        is pandas.DataFrame()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">what</span><span class="p">):</span>
        <span class="n">logs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="s1">&#39;data&#39;</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">what</span><span class="p">):</span>
        <span class="n">logs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="s1">&#39;contour&#39;</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">what</span><span class="p">):</span>
        <span class="n">logs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="s1">&#39;mesh&#39;</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">what</span><span class="p">):</span>
        <span class="n">logs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="s1">&#39;features&#39;</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">what</span><span class="p">):</span>
        <span class="n">logs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="s1">&#39;results&#39;</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">what</span><span class="p">):</span>
        <span class="n">logs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="s1">&#39;tags&#39;</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">what</span><span class="p">):</span>
        <span class="n">logs</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span></div>
    <span class="k">return</span> <span class="n">create_logfile</span><span class="p">(</span><span class="n">logs</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>


<div class="viewcode-block" id="blockPrint"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.blockPrint">[docs]</a><span class="k">def</span> <span class="nf">blockPrint</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Suppress all print output after call.&quot;&quot;&quot;</span></div>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="enablePrint"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.enablePrint">[docs]</a><span class="k">def</span> <span class="nf">enablePrint</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Enable all print output after call, if it was blocked before.&quot;&quot;&quot;</span></div>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">__stdout__</span>


<div class="viewcode-block" id="save_polydata_ply"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.save_polydata_ply">[docs]</a><span class="k">def</span> <span class="nf">save_polydata_ply</span><span class="p">(</span><span class="n">what</span><span class="p">,</span> <span class="n">where</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Save vtk.PolyData() as .ply file.</span>

<span class="sd">    File location can be specified.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    what : vtk.PolyData()</span>
<span class="sd">        PolyData to be saved.</span>

<span class="sd">    where : string</span>
<span class="sd">        File location including file name without extension. .ply is automaticly</span>
<span class="sd">        added.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">meshwriter</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPLYWriter</span><span class="p">()</span>
    <span class="n">meshwriter</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="n">what</span><span class="p">)</span>
    <span class="n">meshwriter</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">where</span> <span class="o">+</span> <span class="s1">&#39;.ply&#39;</span><span class="p">)</span></div>
    <span class="n">meshwriter</span><span class="o">.</span><span class="n">Write</span><span class="p">()</span>

<div class="viewcode-block" id="readTiff"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.readTiff">[docs]</a><span class="k">def</span> <span class="nf">readTiff</span><span class="p">(</span><span class="n">file_loc</span><span class="p">):</span></div>
    <span class="k">return</span> <span class="n">tiffread</span><span class="p">(</span><span class="n">file_loc</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<div class="viewcode-block" id="curvature_max"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.curvature_max">[docs]</a><span class="k">def</span> <span class="nf">curvature_max</span><span class="p">(</span><span class="n">mesh</span><span class="p">):</span>
   <span class="n">curvature</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkCurvatures</span><span class="p">()</span>

   <span class="k">if</span> <span class="n">vtk</span><span class="o">.</span><span class="n">VTK_MAJOR_VERSION</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
     <span class="n">polyAlg</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">GetProducerPort</span><span class="p">()</span>
     <span class="n">curvature</span><span class="o">.</span><span class="n">SetInputConnection</span><span class="p">(</span><span class="n">polyAlg</span><span class="p">)</span>
   <span class="k">else</span><span class="p">:</span>
     <span class="n">curvature</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>

   <span class="n">curvature</span><span class="o">.</span><span class="n">SetCurvatureTypeToMaximum</span><span class="p">()</span>
   <span class="n">curvature</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
   <span class="n">vtkMaxVals</span> <span class="o">=</span> <span class="n">curvature</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetAbstractArray</span><span class="p">(</span><span class="s1">&#39;Maximum_Curvature&#39;</span><span class="p">)</span>
   <span class="n">maxVals</span> <span class="o">=</span> <span class="n">nps</span><span class="o">.</span><span class="n">vtk_to_numpy</span><span class="p">(</span><span class="n">vtkMaxVals</span><span class="p">)</span></div>
   <span class="k">return</span> <span class="n">maxVals</span>

<div class="viewcode-block" id="curvature_min"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.curvature_min">[docs]</a><span class="k">def</span> <span class="nf">curvature_min</span><span class="p">(</span><span class="n">mesh</span><span class="p">):</span>
   <span class="n">curvature</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkCurvatures</span><span class="p">()</span>
   <span class="k">if</span> <span class="n">vtk</span><span class="o">.</span><span class="n">VTK_MAJOR_VERSION</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
     <span class="n">polyAlg</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">GetProducerPort</span><span class="p">()</span>
     <span class="n">curvature</span><span class="o">.</span><span class="n">SetInputConnection</span><span class="p">(</span><span class="n">polyAlg</span><span class="p">)</span>
   <span class="k">else</span><span class="p">:</span>
     <span class="n">curvature</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>

   <span class="n">curvature</span><span class="o">.</span><span class="n">SetCurvatureTypeToMinimum</span><span class="p">()</span>
   <span class="n">curvature</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
   <span class="n">vtkMinVals</span> <span class="o">=</span> <span class="n">curvature</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetAbstractArray</span><span class="p">(</span><span class="s1">&#39;Minimum_Curvature&#39;</span><span class="p">)</span>
   <span class="n">minVals</span> <span class="o">=</span> <span class="n">nps</span><span class="o">.</span><span class="n">vtk_to_numpy</span><span class="p">(</span><span class="n">vtkMinVals</span><span class="p">)</span></div>
   <span class="k">return</span> <span class="n">minVals</span>

<div class="viewcode-block" id="curvature_gauss"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.curvature_gauss">[docs]</a><span class="k">def</span> <span class="nf">curvature_gauss</span><span class="p">(</span><span class="n">mesh</span><span class="p">):</span>
   <span class="n">curvature</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkCurvatures</span><span class="p">()</span>
   <span class="k">if</span> <span class="n">vtk</span><span class="o">.</span><span class="n">VTK_MAJOR_VERSION</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
     <span class="n">polyAlg</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">GetProducerPort</span><span class="p">()</span>
     <span class="n">curvature</span><span class="o">.</span><span class="n">SetInputConnection</span><span class="p">(</span><span class="n">polyAlg</span><span class="p">)</span>
   <span class="k">else</span><span class="p">:</span>
     <span class="n">curvature</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>

   <span class="n">curvature</span><span class="o">.</span><span class="n">SetCurvatureTypeToGaussian</span><span class="p">()</span>
   <span class="n">curvature</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
   <span class="n">vtkGaussVals</span> <span class="o">=</span> <span class="n">curvature</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetAbstractArray</span><span class="p">(</span><span class="s1">&#39;Gauss_Curvature&#39;</span><span class="p">)</span>
   <span class="n">gaussVals</span> <span class="o">=</span> <span class="n">nps</span><span class="o">.</span><span class="n">vtk_to_numpy</span><span class="p">(</span><span class="n">vtkGaussVals</span><span class="p">)</span></div>
   <span class="k">return</span> <span class="n">gaussVals</span>

<div class="viewcode-block" id="curvature_mean"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.curvature_mean">[docs]</a><span class="k">def</span> <span class="nf">curvature_mean</span><span class="p">(</span><span class="n">mesh</span><span class="p">):</span>
   <span class="n">curvature</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkCurvatures</span><span class="p">()</span>

   <span class="k">if</span> <span class="n">vtk</span><span class="o">.</span><span class="n">VTK_MAJOR_VERSION</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
     <span class="n">polyAlg</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">GetProducerPort</span><span class="p">()</span>
     <span class="n">curvature</span><span class="o">.</span><span class="n">SetInputConnection</span><span class="p">(</span><span class="n">polyAlg</span><span class="p">)</span>
   <span class="k">else</span><span class="p">:</span>
     <span class="n">curvature</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>
   <span class="n">curvature</span><span class="o">.</span><span class="n">SetCurvatureTypeToMean</span><span class="p">()</span>
   <span class="n">curvature</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
   <span class="n">vtkMeanVals</span> <span class="o">=</span> <span class="n">curvature</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetAbstractArray</span><span class="p">(</span><span class="s1">&#39;Mean_Curvature&#39;</span><span class="p">)</span>
   <span class="n">meanVals</span> <span class="o">=</span> <span class="n">nps</span><span class="o">.</span><span class="n">vtk_to_numpy</span><span class="p">(</span><span class="n">vtkMeanVals</span><span class="p">)</span></div>
   <span class="k">return</span> <span class="n">meanVals</span>

<div class="viewcode-block" id="get_connected_vertices"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.get_connected_vertices">[docs]</a><span class="k">def</span> <span class="nf">get_connected_vertices</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">includeSelf</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="n">connectedVertices</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">includeSelf</span><span class="p">:</span>
      <span class="n">connectedVertices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

    <span class="n">cellIdList</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkIdList</span><span class="p">()</span>
    <span class="n">mesh</span><span class="o">.</span><span class="n">GetPointCells</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="n">cellIdList</span><span class="p">)</span>

    <span class="c1"># Loop through each cell using the seed point</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">cellIdList</span><span class="o">.</span><span class="n">GetNumberOfIds</span><span class="p">()):</span>
        <span class="n">cell</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">GetCell</span><span class="p">(</span><span class="n">cellIdList</span><span class="o">.</span><span class="n">GetId</span><span class="p">(</span><span class="n">ii</span><span class="p">))</span>		<span class="c1"># get current cell</span>

        <span class="c1"># Loop through the edges of the point and add all points on these.</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">GetNumberOfEdges</span><span class="p">()):</span>
            <span class="n">pointIdList</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">GetEdge</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">GetPointIds</span><span class="p">()</span>

            <span class="c1"># if one of the points on the edge are the vertex point, add the</span>
            <span class="c1"># other one</span>
            <span class="k">if</span> <span class="n">pointIdList</span><span class="o">.</span><span class="n">GetId</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">seed</span><span class="p">:</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">pointIdList</span><span class="o">.</span><span class="n">GetId</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">connectedVertices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">pointIdList</span><span class="o">.</span><span class="n">GetId</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">seed</span><span class="p">:</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">pointIdList</span><span class="o">.</span><span class="n">GetId</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">connectedVertices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
</div>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">connectedVertices</span><span class="p">)</span>

<div class="viewcode-block" id="get_curvatures"><a class="viewcode-back" href="../../phenotastic.html#phenotastic.Meristem_Phenotyper_3D.get_curvatures">[docs]</a><span class="k">def</span> <span class="nf">get_curvatures</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">dist_</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">curv_types</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="n">operations</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">ignore_boundary</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

<span class="c1">#  curv_types=[&#39;mean&#39;]</span>
<span class="c1">#  operations = []</span>
<span class="c1">#  ignore_boundary=True</span>
<span class="c1">#  #  A.mesh = calculate_curvature(A, curvature_type=curvature_type)</span>
  <span class="n">A</span><span class="o">.</span><span class="n">calculate_curvatures</span><span class="p">(</span><span class="n">curv_types</span><span class="o">=</span><span class="n">curv_types</span><span class="p">,</span> <span class="n">operations</span><span class="o">=</span><span class="n">operations</span><span class="p">)</span>
  <span class="n">curvs</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">curvature_type</span><span class="p">)</span>
  <span class="n">curvs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">nps</span><span class="o">.</span><span class="n">vtk_to_numpy</span><span class="p">(</span><span class="n">curvs</span><span class="p">))</span>

  <span class="sd">&#39;&#39;&#39; Compute graph &#39;&#39;&#39;</span>
  <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
  <span class="n">edges</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">nPoints</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">()</span>
  <span class="n">neighs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">get_connected_vertices</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">ii</span><span class="p">)</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">nPoints</span><span class="p">)])</span>

  <span class="k">if</span> <span class="n">ignore_boundary</span><span class="p">:</span>
    <span class="n">boundary</span> <span class="o">=</span> <span class="n">boa</span><span class="o">.</span><span class="n">get_boundary_points</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">boundary</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">curvs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">boundary</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;Nan&#39;</span><span class="p">)</span>

  <span class="c1"># Make everything connect with its neighbours</span>
  <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">neighs</span><span class="p">):</span>
    <span class="n">edges</span><span class="o">.</span><span class="n">extend</span><span class="p">([(</span><span class="n">key</span><span class="p">,</span> <span class="n">ii</span><span class="p">)</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">value</span> <span class="k">if</span> <span class="n">ii</span> <span class="o">&gt;</span> <span class="n">key</span><span class="p">])</span>
  <span class="n">G</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span>

  <span class="sd">&#39;&#39;&#39; Average over extended neighborhood &#39;&#39;&#39;</span>
  <span class="n">curvs</span> <span class="o">=</span> <span class="p">[</span><span class="n">curvs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">single_source_shortest_path_length</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="n">dist_</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span><span class="o">.</span><span class="n">mean</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">nPoints</span><span class="p">)]</span>
</div>
  <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">curvs</span><span class="p">)</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Example</span>
<span class="sd">=======</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="c1">#if __name__ == &quot;__main__&quot;:</span>
<span class="c1">#    A = AutoPhenotype()</span>
<span class="c1">#    A.data, _ = tiffread(&#39;test_images/meristem_test.tif&#39;)</span>
<span class="c1">#    A.contour_fit_threshold()</span>
<span class="c1">#    A.mesh_conversion()</span>
<span class="c1">#    A.clean_mesh()</span>
<span class="c1">#    A.smooth_mesh(300, .3)</span>
<span class="c1">#    A.curvature_slice()</span>
<span class="c1">#    A.feature_extraction()</span>
<span class="c1">#    A.sphere_fit()</span>
<span class="c1">#    A.sphere_evaluation()</span>
<span class="c1">#    A.paraboloid_fit_mersitem()</span>
<span class="c1">#    print A.results</span>
<span class="c1">#    A.show_spheres_and_features()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Henrik Ahl.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>