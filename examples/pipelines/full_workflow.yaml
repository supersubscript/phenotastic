# Full Workflow Pipeline
# ======================
# Complete pipeline from raw 3D image to domain analysis.
# Input: 3D image file (TIFF)

steps:
  # -------------------------
  # Phase 1: Image Processing
  # -------------------------
  - name: contour
    params:
      iterations: 25
      smoothing: 1
      masking_factor: 0.75
      target_resolution: [0.5, 0.5, 0.5]
      gaussian_sigma: [1.0, 1.0, 1.0]
      gaussian_iterations: 5
      register_stack: true
      chan_vese_lambda1: 1.0
      chan_vese_lambda2: 1.0
      fill_slices: true
      crop: true

  # -------------------------
  # Phase 2: Mesh Creation
  # -------------------------
  - name: create_mesh
    params:
      step_size: 1

  # -------------------------
  # Phase 3: Cleanup
  # -------------------------
  - name: clean

  - name: extract_largest

  - name: repair_holes
    params:
      max_hole_edges: 100
      refine: true

  # -------------------------
  # Phase 4: Smoothing Pipeline
  # -------------------------
  - name: smooth
    params:
      iterations: 100
      relaxation_factor: 0.01

  - name: remesh
    params:
      n_clusters: 10000
      subdivisions: 3

  - name: smooth
    params:
      iterations: 50
      relaxation_factor: 0.01

  # -------------------------
  # Phase 5: Normal-Based Filtering
  # -------------------------
  # Rotate to align with processing axis
  - name: rotate
    params:
      axis: y
      angle: -90

  - name: remove_normals
    params:
      threshold_angle: 60
      angle_type: polar

  # Rotate back
  - name: rotate
    params:
      axis: y
      angle: 90

  # Repair after filtering
  - name: make_manifold
    params:
      hole_edges: 100

  - name: extract_largest

  - name: repair_holes
    params:
      max_hole_edges: 100

  # Final smoothing
  - name: smooth_boundary
    params:
      iterations: 20
      sigma: 0.1

  # -------------------------
  # Phase 6: Domain Segmentation
  # -------------------------
  - name: compute_curvature
    params:
      curvature_type: mean

  - name: filter_scalars
    params:
      function: median
      iterations: 2

  - name: segment_domains

  # -------------------------
  # Phase 7: Domain Merging
  # -------------------------
  - name: merge_small
    params:
      threshold: 50
      metric: points
      mode: border

  - name: merge_angles
    params:
      threshold: 20
      meristem_method: center_of_mass

  - name: merge_engulfing
    params:
      threshold: 0.9

  # -------------------------
  # Phase 8: Analysis
  # -------------------------
  - name: define_meristem
    params:
      method: center_of_mass

  - name: extract_domaindata
